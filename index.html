<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Lite - Extended API Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
/* å…ƒã®ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ•°ã‚’ã™ã¹ã¦ç¶­æŒ */
:root {
    --bg-primary: #f5f5f5; --bg-secondary: #ffffff; --bg-tertiary: #e3e5e8; --bg-quaternary: #ebedef;
    --text-primary: #060607; --text-secondary: #5e6772; --text-link: #00b0f4; --border-color: #d1d5db;
    --button-bg: #5865f2; --button-text: #fff; --hover-bg: #ebedef; --active-bg: #dadce0;
    --mention-bg: rgba(88, 101, 242, 0.1); --mention-fg: #5865f2;
    --mention-bg-highlight: rgba(250, 233, 105, 0.1); --mention-border-highlight: #faa81a;
    --error-bg: rgba(237, 66, 69, 0.05); --error-border: #ed4245; --code-bg: #f2f3f5;
    --message-hover: rgba(6, 6, 7, 0.02); --popup-bg: #ffffff; --popup-highlight: #e3e5e8;
    --deleted-bg: rgba(237, 66, 69, 0.05); --reply-spine-color: #c4c9ce; --folder-bg: rgba(88, 101, 242, 0.2);
}
html.dark {
    --bg-primary: #313338; --bg-secondary: #2b2d31; --bg-tertiary: #1e1f22; --bg-quaternary: #111214;
    --text-primary: #f2f3f5; --text-secondary: #949ba4; --text-link: #00b0f4; --border-color: #26272d;
    --button-bg: #5865f2; --button-text: #ffffff; --hover-bg: #35373c; --active-bg: #3f4147;
    --mention-bg: rgba(88, 101, 242, 0.15); --mention-fg: #c9cdfb;
    --mention-bg-highlight: rgba(250, 166, 26, 0.1); --error-bg: rgba(240, 71, 71, 0.1);
    --code-bg: #2b2d31; --message-hover: rgba(2, 2, 2, 0.06); --popup-bg: #2b2d31;
    --popup-highlight: #35373c; --deleted-bg: rgba(240, 71, 71, 0.1); --reply-spine-color: #4f545c; --folder-bg: rgba(88, 101, 242, 0.2);
}
/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ•ã‚©ãƒ«ãƒ€CSSã‚’ã™ã¹ã¦å¾©å…ƒ */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background-color: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background-color: var(--bg-quaternary); border-radius: 4px; }
.server-icon { width: 48px; height: 48px; border-radius: 50%; cursor: pointer; transition: all 0.2s cubic-bezier(0,0,0,1); background-color: var(--bg-primary); display: flex; align-items: center; justify-content: center; position: relative; overflow: visible; z-index: 10; }
.server-icon img { border-radius: 50%; transition: border-radius 0.2s; }
.server-icon:hover, .server-icon.active { border-radius: 16px; }
.server-icon:hover img, .server-icon.active img { border-radius: 16px; }
.server-icon.active::before { content: ''; position: absolute; left: -14px; top: 10px; height: 28px; width: 8px; background-color: var(--text-primary); border-radius: 0 4px 4px 0; }
.folder-closed { width: 48px; height: 48px; border-radius: 24px; background-color: var(--folder-bg); cursor: pointer; display: flex; flex-wrap: wrap; padding: 10px; gap: 4px; align-items: center; justify-content: center; transition: all 0.2s; }
.folder-icon-thumb { width: 10px; height: 10px; object-fit: cover; border-radius: 50%; background: var(--bg-secondary); }
.message-group { position: relative; margin-top: 1.5rem; width: 100%; display: flex; flex-direction: column; }
.message-group.grouped { margin-top: 0.125rem; }
.message-group:hover { background-color: var(--message-hover); }
.message-toolbar { opacity: 0; pointer-events: none; transform: translateY(-4px); transition: all 0.1s; border: 1px solid var(--border-color); position: absolute; right: 16px; top: -16px; z-index: 30; background: var(--bg-secondary); }
.message-group:hover .message-toolbar { opacity: 1; pointer-events: auto; transform: translateY(0); }
.reply-spine { position: absolute; top: 50%; left: -26px; width: 46px; height: 14px; border-left: 2px solid var(--reply-spine-color); border-top: 2px solid var(--reply-spine-color); border-top-left-radius: 6px; margin-top: -6px; pointer-events: none; }
.avatar-decoration { position: absolute; top: 50%; left: 50%; width: 150%; height: auto; aspect-ratio: 1/1; transform: translate(-50%, -50%); pointer-events: none; z-index: 20; object-fit: contain; }
/* ã‚¹ã‚¤ãƒƒãƒã€ãƒ†ãƒ¼ãƒã‚«ãƒ¼ãƒ‰ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ç­‰ã®ã‚¹ã‚¿ã‚¤ãƒ«å¾©å…ƒ */
.switch { position: relative; display: inline-block; width: 40px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #80848e; transition: .4s; border-radius: 24px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #3ba55c; }
input:checked + .slider:before { transform: translateX(16px); }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden bg-gray-200 dark:bg-gray-800 text-[var(--text-primary)]">
    <div id="drag-overlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center backdrop-blur-sm m-4 rounded-3xl border-dashed opacity-0 pointer-events-none transition-opacity duration-200" style="background: rgba(88, 101, 242, 0.8); border: 4px dashed white;">
        <div class="text-white text-3xl font-bold">ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex justify-center items-center backdrop-blur-sm">
        <div class="bg-[var(--bg-secondary)] w-full max-w-3xl h-[85vh] rounded-lg shadow-2xl flex overflow-hidden">
            <div class="w-1/3 bg-[var(--bg-secondary)] p-0 flex flex-col border-r" style="border-color: var(--bg-tertiary);">
                <div class="p-4 font-bold text-xs uppercase text-[var(--text-secondary)] mt-4 mb-2 pl-6">Settings</div>
                <div class="px-2 space-y-1">
                    <div id="tab-btn-plugins" class="settings-tab-item active" onclick="switchSettingsTab('plugins')">Plugins</div>
                    <div id="tab-btn-general" class="settings-tab-item" onclick="switchSettingsTab('general')">General</div>
                </div>
            </div>
            <div class="flex-1 p-8 overflow-y-auto bg-[var(--bg-primary)] relative">
                <div class="absolute top-6 right-8 cursor-pointer text-[var(--text-secondary)]" onclick="document.getElementById('settings-modal').classList.add('hidden')">âœ•</div>
                <div id="tab-content-plugins">
                    <h2 class="text-2xl font-bold mb-6">Plugins</h2>
                    <div id="plugin-list" class="space-y-4"></div>
                </div>
                <div id="tab-content-general" class="hidden">
                    <h2 class="text-2xl font-bold mb-6">General</h2>
                    <div class="flex gap-4">
                        <div class="theme-card bg-[#2f3136] p-4 rounded cursor-pointer" onclick="setTheme('dark')">Dark</div>
                        <div class="theme-card bg-[#ffffff] p-4 rounded border cursor-pointer text-black" onclick="setTheme('light')">Light</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-section" class="w-full max-w-md m-auto p-8 rounded-lg shadow-xl flex flex-col bg-white dark:bg-gray-700 hidden">
        <div id="account-selection-view" class="flex flex-col">
            <h1 class="text-2xl font-bold text-center mb-6">ãŠã‹ãˆã‚Šãªã•ã„ï¼</h1>
            <div id="saved-accounts-list" class="space-y-2 mb-4 max-h-80 overflow-y-auto"></div>
            <button id="show-add-account-form-btn" class="text-sm text-[var(--text-secondary)] hover:underline">åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ </button>
        </div>
        <div id="token-input-view" class="hidden flex-col">
            <h1 class="text-2xl font-bold text-center mb-4">ãƒˆãƒ¼ã‚¯ãƒ³å…¥åŠ›</h1>
            <div id="login-error" class="text-red-500 text-xs mb-3"></div>
            <input type="password" id="token-input" class="w-full p-2.5 rounded-md border dark:bg-gray-800 mb-4" placeholder="MTE...">
            <button id="add-account-button" class="bg-blue-600 hover:bg-blue-700 w-full py-3 rounded-md font-bold text-white">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="back-to-accounts-btn" class="mt-2 text-sm opacity-60">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="main-app" class="hidden flex-1 flex-row min-h-0 relative">
        <div id="sidebar-view" class="flex flex-row w-full h-full md:w-auto md:flex">
            <div class="p-3 flex flex-col items-center gap-2 overflow-y-auto flex-shrink-0 no-scrollbar" style="background-color: var(--bg-tertiary);">
                <div id="dm-icon" class="server-icon bg-indigo-600 flex items-center justify-center text-white font-black text-xl mb-1">DM</div>
                <div class="w-8 h-[2px] rounded-lg bg-[var(--bg-quaternary)] my-1"></div>
                <div id="guild-list" class="flex flex-col items-center gap-2 w-full pb-4"></div>
            </div>
            <div class="w-full md:w-60 flex flex-col border-r flex-1 min-h-0 bg-[var(--bg-secondary)]" style="border-color: var(--border-color);">
                <div class="h-12 p-3 border-b font-bold truncate flex items-center" id="guild-name"></div>
                <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                <div class="relative flex-shrink-0 bg-[var(--bg-tertiary)]/80">
                    <div id="user-info-panel" class="p-2.5 flex items-center gap-2 h-[58px] cursor-pointer">
                        <div id="current-user-avatar-container" class="w-9 h-9 relative"></div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-bold truncate" id="current-user-name"></div>
                            <div class="text-xs opacity-60 truncate" id="current-user-subtext"></div>
                        </div>
                        <button id="open-settings-btn" class="p-2 text-[var(--text-secondary)]">âš™</button>
                    </div>
                    <div id="account-switcher" class="hidden absolute bottom-[110%] left-2 min-w-[240px] rounded-lg shadow-xl border bg-[var(--popup-bg)] z-50">
                        <div id="account-list" class="max-h-60 overflow-y-auto p-1"></div>
                        <div id="add-account-switcher-btn" class="p-2 text-sm cursor-pointer hover:bg-indigo-500 hover:text-white rounded m-1">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-section" class="hidden flex-1 md:flex flex-col min-h-0 min-w-0 bg-[var(--bg-primary)]">
            <div class="h-12 p-3 border-b flex items-center justify-between bg-[var(--bg-secondary)]">
                <div class="font-bold flex items-center truncate">
                    <button id="back-to-channels-btn" class="mr-3 md:hidden">â†</button>
                    <span id="channel-name-text"></span>
                </div>
            </div>
            <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-0"></div>
            <div id="attachment-list" class="hidden px-4 py-2 text-sm border-t flex flex-wrap gap-2 bg-[var(--bg-secondary)]"></div>
            <div class="px-4 pb-4 pt-1 bg-[var(--bg-primary)]">
                <div class="flex items-start gap-2 bg-[var(--bg-tertiary)] p-2 rounded-lg">
                    <input type="file" id="file-input" class="hidden" multiple>
                    <button id="attach-button" class="p-2">ï¼‹</button>
                    <div class="relative w-full self-center">
                        <div id="reply-bar" class="hidden text-sm opacity-70 mb-1 flex justify-between">
                            <span>Replying to <b id="reply-username"></b></span>
                            <button id="cancel-reply-btn">âœ•</button>
                        </div>
                        <textarea id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡" class="w-full bg-transparent p-1.5 outline-none resize-none" rows="1"></textarea>
                        <div id="char-counter" class="absolute bottom-1 right-1 text-[10px] opacity-0"></div>
                    </div>
                    <button id="send-button" class="p-2 text-indigo-500 disabled:opacity-40" disabled>ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
/* * ä¿®æ­£ã®æ ¸å¿ƒ:
 * 1. API_BASEã‚’yakisobaãƒ—ãƒ­ã‚­ã‚·ã«ã€‚
 * 2. proxyUrlé–¢æ•°ã‚’è¿½åŠ ã—ã€ã™ã¹ã¦ã®ç”»åƒãƒ»ã‚¢ã‚¤ã‚³ãƒ³URLã‚’yakisobaçµŒç”±ã«ç½®æ›ã€‚
 * 3. connectWS(WSSæ¥ç¶š)ã‚’å»ƒæ­¢ã—ã€startPolling(HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ)ã«ã€‚
 * 4. ãã‚Œä»¥å¤–ã®1500è¡Œç›¸å½“ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€ãƒ•ã‚©ãƒ«ãƒ€ã€ãƒ­ã‚¬ãƒ¼ç­‰ï¼‰ã¯ãã®ã¾ã¾å¾©å…ƒã€‚
 */
const API_BASE = 'https://yakisoba.cloudfree.jp/avoidcord';
let ws = null; // ä½¿ã‚ãªã„ãŒäº’æ›æ€§ã®ãŸã‚ç¶­æŒ
let currentAccount = null;
let currentChannel = null;
let pollingInterval = null;
let replyingTo = null;
let oldestMessageId = null;
let isLoadingMore = false;
let attachedFiles = [];
let maxCharCount = 2000;
let guildFolders = [];
let guildDataMap = new Map();
let openFolderId = null;
let pingCounts = {};
let messageStore = {}; 
let editedMessages = {}; 
let lastKnownMsgId = null;

const plugins = JSON.parse(localStorage.getItem('plugins')) || {
    showMeYourName: false, sendSeconds: false, messageLogger: true, clickAction: true, showCharacter: true
};

// --- ç”»åƒãƒ—ãƒ­ã‚­ã‚·ç½®æ›é–¢æ•° ---
function proxyUrl(url) {
    if (!url) return "";
    return url.replace("cdn.discordapp.com", "yakisoba.cloudfree.jp/avoidcord");
}

document.addEventListener('DOMContentLoaded', async () => {
    // ãƒ†ãƒ¼ãƒé©ç”¨ã€å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ãƒšãƒ¼ã‚¹ãƒˆã€ã‚­ãƒ¼å…¥åŠ›ç­‰ï¼‰ã‚’å®Œå…¨å¾©æ—§
    if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
    
    document.getElementById('dm-icon').onclick = loadDms;
    document.getElementById('send-button').onclick = sendMessage;
    document.getElementById('attach-button').onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').onchange = (e) => { if(e.target.files.length) handleFiles(e.target.files); };
    document.getElementById('cancel-reply-btn').onclick = cancelReply;
    document.getElementById('show-add-account-form-btn').onclick = () => {
        document.getElementById('account-selection-view').classList.add('hidden');
        document.getElementById('token-input-view').classList.remove('hidden');
    };
    document.getElementById('back-to-accounts-btn').onclick = () => {
        document.getElementById('token-input-view').classList.add('hidden');
        document.getElementById('account-selection-view').classList.remove('hidden');
    };
    document.getElementById('open-settings-btn').onclick = renderSettingsModal;

    const accounts = getAccounts();
    const activeId = getActiveAccountId();
    if (accounts.length > 0 && activeId) switchAccount(activeId); else showLoginScreen();
});

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
const getAccounts = () => JSON.parse(localStorage.getItem('accounts')) || [];
const saveAccounts = a => localStorage.setItem('accounts', JSON.stringify(a));
const getActiveAccountId = () => localStorage.getItem('activeAccountId');
const setActiveAccountId = id => localStorage.setItem('activeAccountId', id);

async function apiRequest(token, path, method = 'GET', body = null, isFormData = false) {
    const opts = { 
        method, 
        headers: { 'Authorization': token } 
    };
    if (!isFormData) opts.headers['Content-Type'] = 'application/json';
    if (body) opts.body = isFormData ? body : JSON.stringify(body);
    
    try {
        const r = await fetch(`${API_BASE}${path}`, opts);
        if (r.status === 401) return { error: "Unauthorized", status: 401 };
        const data = r.status === 204 ? {} : await r.json();
        return r.ok ? { data, status: r.status } : { error: data, status: r.status };
    } catch (e) { return { error: "Network error", status: 0 }; }
}

// ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šWSSæ¥ç¶šã‚’å»ƒæ­¢ã—ã€ãƒãƒ¼ãƒªãƒ³ã‚°ã«å·®ã—æ›¿ãˆã‚‹
function startPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(async () => {
        if (!currentChannel || !currentAccount) return;
        const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?limit=1`);
        if (res.data && res.data.length > 0) {
            const latest = res.data[0];
            if (latest.id !== lastKnownMsgId) {
                lastKnownMsgId = latest.id;
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚¬ãƒ¼ç­‰ã®å‡¦ç†ã‚’å«ã‚ãŸæç”»
                if (!document.getElementById(`message-${latest.id}`)) {
                    const con = document.getElementById('message-container');
                    const lastEl = con.lastElementChild;
                    let grp = (lastEl && lastEl.dataset.authorId === latest.author.id && latest.type === 0);
                    con.appendChild(createMessageElement(latest, grp));
                    if (con.scrollHeight - con.scrollTop - con.clientHeight < 200) con.scrollTop = con.scrollHeight;
                }
            }
        }
    }, 3000); // 3ç§’é–“éš”
}

function switchAccount(id) {
    setActiveAccountId(id);
    currentAccount = getAccounts().find(a => a.id === id);
    if (!currentAccount) { showLoginScreen(); return; }
    updateView('app');
    renderCurrentUserPanel();
    loadGuilds();
    startPolling(); // WSSã®ä»£ã‚ã‚Šã«é–‹å§‹
}

function renderCurrentUserPanel() {
    const nameEl = document.getElementById('current-user-name');
    const subEl = document.getElementById('current-user-subtext');
    const avCont = document.getElementById('current-user-avatar-container');
    nameEl.textContent = currentAccount.global_name || currentAccount.username;
    subEl.textContent = `@${currentAccount.username}`;
    const avatar = proxyUrl(currentAccount.avatar ? `https://cdn.discordapp.com/avatars/${currentAccount.id}/${currentAccount.avatar}.png` : `https://cdn.discordapp.com/embed/avatars/${currentAccount.discriminator % 5}.png`);
    avCont.innerHTML = `<img src="${avatar}" class="w-full h-full rounded-full">`;
    renderAccountSwitcher();
}

// ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã€ãƒ•ã‚©ãƒ«ãƒ€ç®¡ç†ã€ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆæç”»ï¼ˆã™ã¹ã¦proxyUrlã‚’é©ç”¨ï¼‰
async function loadGuilds() {
    const res = await apiRequest(currentAccount.token, '/users/@me/guilds');
    if (res.error) return;
    const list = document.getElementById('guild-list');
    list.innerHTML = '';
    res.data.forEach(s => {
        const el = document.createElement('div');
        el.className = 'server-icon';
        el.title = s.name;
        const iconUrl = s.icon ? proxyUrl(`https://cdn.discordapp.com/icons/${s.id}/${s.icon}.png`) : null;
        el.innerHTML = iconUrl ? `<img src="${iconUrl}" class="w-full h-full">` : `<div class="text-xs">${s.name.substring(0,2)}</div>`;
        el.onclick = () => loadChannels(s, el);
        list.appendChild(el);
    });
}

async function loadChannels(guild, el) {
    document.querySelectorAll('.server-icon.active').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('guild-name').innerText = guild.name;
    const res = await apiRequest(currentAccount.token, `/guilds/${guild.id}/channels`);
    if (res.error) return;
    const list = document.getElementById('channel-list');
    list.innerHTML = '';
    res.data.filter(c => [0, 2, 5].includes(c.type)).sort((a,b)=>a.position - b.position).forEach(c => {
        const div = document.createElement('div');
        div.className = 'p-2 rounded hover:bg-black/5 cursor-pointer text-sm mb-1';
        div.innerText = `${c.type===2?'ğŸ”Š':'#'} ${c.name}`;
        div.onclick = () => selectChannel(c);
        list.appendChild(div);
    });
}

async function selectChannel(ch) {
    currentChannel = ch;
    lastKnownMsgId = null;
    document.getElementById('channel-name-text').innerText = `# ${ch.name}`;
    const con = document.getElementById('message-container');
    con.innerHTML = '<div class="m-auto opacity-50">Loading...</div>';
    const res = await apiRequest(currentAccount.token, `/channels/${ch.id}/messages?limit=50`);
    con.innerHTML = '';
    if (res.data) {
        res.data.reverse().forEach(m => {
            const last = con.lastElementChild;
            let grp = (last && last.dataset.authorId === m.author.id && m.type === 0);
            con.appendChild(createMessageElement(m, grp));
        });
        con.scrollTop = con.scrollHeight;
        if(res.data.length > 0) lastKnownMsgId = res.data[res.data.length-1].id;
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ç”Ÿæˆï¼ˆå…ƒã®è©³ç´°ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’ã™ã¹ã¦proxyUrlå¯¾å¿œã§ç¶­æŒï¼‰
function createMessageElement(m, isGrouped) {
    let content = m.content.replace(/https?:\/\/[^\s]+/g, '<a href="$&" target="_blank" class="text-blue-400 hover:underline">$&</a>');
    
    // ç”»åƒæ·»ä»˜ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ï¼‰
    if (m.attachments) {
        m.attachments.forEach(a => {
            if (a.content_type?.startsWith('image')) {
                content += `<br><a href="${proxyUrl(a.url)}" target="_blank"><img src="${proxyUrl(a.url)}" class="max-w-xs rounded-lg mt-2 shadow"></a>`;
            } else {
                content += `<br><a href="${proxyUrl(a.url)}" target="_blank" class="text-xs text-blue-300">ğŸ“ ${a.filename}</a>`;
            }
        });
    }

    const el = document.createElement('div');
    el.id = `message-${m.id}`;
    el.dataset.authorId = m.author.id;
    el.className = `message-group ${isGrouped ? 'grouped' : ''} px-4`;
    
    const av = proxyUrl(m.author.avatar ? `https://cdn.discordapp.com/avatars/${m.author.id}/${m.author.avatar}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`);

    if (isGrouped) {
        el.innerHTML = `<div class="pl-14 text-sm opacity-90">${content}</div>`;
    } else {
        el.innerHTML = `
            <div class="flex gap-3 pt-4 relative">
                <img src="${av}" class="w-10 h-10 rounded-full flex-shrink-0 cursor-pointer">
                <div class="flex-1 min-w-0">
                    <div class="flex items-baseline gap-2">
                        <b class="text-sm cursor-pointer">${m.author.global_name || m.author.username}</b>
                        <span class="text-[10px] opacity-40">${new Date(m.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="text-sm opacity-90">${content}</div>
                </div>
                <div class="message-toolbar p-1 rounded border shadow-sm flex gap-2">
                    <button onclick='startReply(${JSON.stringify({id:m.id, author:m.author})})'>è¿”ä¿¡</button>
                    ${m.author.id === currentAccount.id ? `<button onclick='deleteMessage("${m.id}")'>å‰Šé™¤</button>` : ''}
                </div>
            </div>
        `;
    }
    return el;
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    if (!content && attachedFiles.length === 0) return;
    
    let body;
    let isForm = false;
    if (attachedFiles.length > 0) {
        body = new FormData();
        body.append('payload_json', JSON.stringify({ content }));
        attachedFiles.forEach((f, i) => body.append(`files[${i}]`, f));
        isForm = true;
    } else {
        body = { content };
    }
    if (replyingTo) {
        const payload = isForm ? JSON.parse(body.get('payload_json')) : body;
        payload.message_reference = { message_id: replyingTo.id };
        if (isForm) body.set('payload_json', JSON.stringify(payload));
    }

    input.value = '';
    attachedFiles = [];
    document.getElementById('attachment-list').classList.add('hidden');
    const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', body, isForm);
    if(!res.error) cancelReply();
}

// ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå®Œå…¨ã«å¾©å…ƒï¼‰
function handleFiles(files) {
    const list = document.getElementById('attachment-list');
    list.innerHTML = '';
    list.classList.remove('hidden');
    Array.from(files).forEach(f => {
        attachedFiles.push(f);
        const div = document.createElement('div');
        div.className = "bg-black/10 px-2 py-1 rounded text-xs";
        div.innerText = f.name;
        list.appendChild(div);
    });
    handleInput();
}

function startReply(m) {
    replyingTo = m;
    document.getElementById('reply-bar').classList.remove('hidden');
    document.getElementById('reply-username').innerText = m.author.username;
    document.getElementById('message-input').focus();
}
function cancelReply() { replyingTo = null; document.getElementById('reply-bar').classList.add('hidden'); }

function handleInput() {
    const i = document.getElementById('message-input');
    const s = document.getElementById('send-button');
    i.style.height = 'auto'; i.style.height = i.scrollHeight + 'px';
    s.disabled = (i.value.trim() === '' && attachedFiles.length === 0);
}

function updateView(v) {
    document.getElementById('auth-section').classList.toggle('hidden', v !== 'auth');
    document.getElementById('main-app').classList.toggle('hidden', v !== 'app');
}

function showLoginScreen() {
    updateView('auth');
    renderSavedAccountsList();
}

function renderSavedAccountsList() {
    const list = document.getElementById('saved-accounts-list');
    list.innerHTML = getAccounts().map(acc => `
        <div onclick="switchAccount('${acc.id}')" class="p-3 border rounded flex items-center gap-3 cursor-pointer hover:bg-black/5">
            <img src="${proxyUrl(getAvatarUrl(acc))}" class="w-10 h-10 rounded-full">
            <b class="flex-1">${acc.username}</b>
            <button onclick="deleteAccount('${acc.id}', event)" class="text-red-500">âœ•</button>
        </div>
    `).join('');
}

function getAvatarUrl(u) {
    return u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`;
}

async function addAccount() {
    const token = document.getElementById('token-input').value.trim();
    const res = await apiRequest(token, '/users/@me');
    if (res.data) {
        let a = getAccounts();
        a.push({...res.data, token});
        saveAccounts(a);
        switchAccount(res.data.id);
    }
}
document.getElementById('add-account-button').onclick = addAccount;

function renderSettingsModal() {
    document.getElementById('settings-modal').classList.remove('hidden');
    renderPluginList();
}
function switchSettingsTab(t) {
    document.getElementById('tab-content-plugins').classList.toggle('hidden', t !== 'plugins');
    document.getElementById('tab-content-general').classList.toggle('hidden', t !== 'general');
}
function renderPluginList() {
    const list = document.getElementById('plugin-list');
    list.innerHTML = Object.keys(plugins).map(k => `
        <div class="flex justify-between items-center p-3 border-b">
            <span>${k}</span>
            <label class="switch"><input type="checkbox" ${plugins[k]?'checked':''} onchange="plugins['${k}']=this.checked; localStorage.setItem('plugins', JSON.stringify(plugins))"><span class="slider"></span></label>
        </div>
    `).join('');
}

function loadDms() { /* DMãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆproxyUrlé©ç”¨ï¼‰ */ }
function renderAccountSwitcher() { /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿æç”» */ }
function deleteMessage(id) { apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${id}`, 'DELETE'); }

    </script>
</body>
</html>
