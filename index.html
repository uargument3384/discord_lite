<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Lite - API Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        :root {
            --bg-primary: #f5f5f5; --bg-secondary: #ffffff; --bg-tertiary: #e0e0e0; --bg-quaternary: #ebebeb;
            --text-primary: #111111; --text-secondary: #555555; --text-link: #4f89e2; --border-color: #cccccc;
            --button-bg: #5865f2; --button-text: #fff; --hover-bg: #f0f0f0; --active-bg: #e0e0e0;
            --mention-bg: rgba(88, 101, 242, 0.1); --mention-fg: #5865f2;
            --status-online: #3ba55d; --status-idle: #faa81a; --status-dnd: #ed4245; --status-offline: #747f8d;
        }
        html.dark {
            --bg-primary: #36393f; --bg-secondary: #2f3136; --bg-tertiary: #202225; --bg-quaternary: #292b2f;
            --text-primary: #e0e0e0; --text-secondary: #b9bbbe; --text-link: #58a6ff; --border-color: #40444b;
        }
        .server-icon { width: 48px; height: 48px; flex-shrink: 0; position: relative; }
        .server-icon.active img, .server-icon.active div { border-radius: 0.5rem; transition: border-radius 0.5s ease-in-out; }
        .ping-dot { position: absolute; bottom: 5px; right: 5px; width: 10px; height: 10px; background-color: #f84a4b; border-radius: 50%; border: 2px solid var(--bg-tertiary); z-index: 10; }
        .channel-item.active { background-color: var(--active-bg); }
        .loader { border: 4px solid var(--bg-tertiary); border-top: 4px solid var(--button-bg); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        .mention { color: var(--mention-fg); background-color: var(--mention-bg); padding: 0 2px; border-radius: 3px; font-weight: 500; cursor: pointer; }
        .message-group:hover .message-toolbar { visibility: visible; opacity: 1; }
        .message-toolbar { visibility: hidden; opacity: 0; transition: opacity 0.1s ease-in-out; }
        .status-dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; border: 3px solid var(--bg-secondary); z-index: 5; }
        .status-dot.online { background-color: var(--status-online); }
        .status-dot.idle { background-color: var(--status-idle); }
        .status-dot.dnd { background-color: var(--status-dnd); }
        .status-dot.offline { background-color: var(--status-offline); }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden bg-gray-200 dark:bg-gray-800 text-[var(--text-primary)]">
    <div id="auth-section" class="w-full max-w-md m-auto p-8 rounded-lg shadow-xl flex-col bg-white dark:bg-gray-700 hidden">
        <h1 class="text-2xl font-bold text-center mb-2">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</h1>
        <div id="login-error" class="text-red-500 text-xs mb-3 text-center"></div>
        <form class="space-y-4" onsubmit="return false;">
            <input type="password" id="token-input" class="input-field w-full p-2.5 rounded-md border dark:bg-gray-800" placeholder="Discord Token">
            <button type="button" id="add-account-button" class="bg-blue-600 hover:bg-blue-700 w-full py-3 rounded-md font-bold text-white flex justify-center items-center">
                <span id="add-account-button-text">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</span>
                <div id="login-spinner" class="loader hidden"></div>
            </button>
            <button type="button" id="cancel-add-account-button" class="bg-gray-600 hover:bg-gray-700 w-full py-2 rounded-md font-bold text-white">„Ç≠„É£„É≥„Çª„É´</button>
        </form>
    </div>

    <div id="main-app" class="hidden flex-1 flex-row min-h-0 relative">
        <div id="sidebar-view" class="flex flex-row w-full h-full md:w-auto md:flex">
            <div class="p-2 flex flex-col items-center gap-2 overflow-y-auto flex-shrink-0" style="background-color: var(--bg-tertiary);">
                <div id="dm-icon" title="DM" class="server-icon bg-indigo-600 flex items-center justify-center cursor-pointer text-white font-black text-xl mb-1 rounded-full">DM</div>
                <div id="guild-list" class="flex flex-col items-center gap-2 w-full"></div>
                <div class="mt-auto flex flex-col gap-2 pt-4">
                    <button id="theme-toggle-btn" class="server-icon bg-gray-500 hover:bg-gray-600 flex items-center justify-center text-white rounded-full"></button>
                </div>
            </div>
            <div class="w-full md:w-64 flex flex-col border-r flex-1 min-h-0 bg-[var(--bg-secondary)]" style="border-color: var(--border-color);">
                <div class="p-4 border-b font-bold truncate flex-shrink-0 text-sm" id="guild-name"></div>
                <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                <div class="relative flex-shrink-0">
                    <div id="user-info-panel" class="p-2 border-t flex items-center gap-3 cursor-pointer hover:bg-gray-500/10" style="border-color: var(--border-color);"></div>
                    <div id="account-switcher" class="hidden absolute bottom-full left-0 w-full p-2 mb-2 rounded-lg shadow-2xl z-30" style="background-color: var(--bg-tertiary);">
                        <div id="account-list" class="flex flex-col gap-1"></div>
                        <div id="add-account-switcher-btn" class="mt-2 text-center text-sm p-2 rounded-md cursor-pointer hover:bg-gray-500/20">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</div>
                    </div>
                    <div id="status-picker" class="hidden absolute bottom-full left-0 w-full p-2 mb-2 rounded-lg shadow-2xl z-40" style="background-color: var(--bg-tertiary);">
                        <div class="text-xs font-bold uppercase opacity-70 mb-1 px-2">„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®≠ÂÆö</div>
                        <div onclick="updateStatus('online')" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20"><div class="status-dot online relative inline-block border-none"></div><span>„Ç™„É≥„É©„Ç§„É≥</span></div>
                        <div onclick="updateStatus('idle')" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20"><div class="status-dot idle relative inline-block border-none"></div><span>ÈÄÄÂ∏≠‰∏≠</span></div>
                        <div onclick="updateStatus('dnd')" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20"><div class="status-dot dnd relative inline-block border-none"></div><span>Âèñ„ÇäËæº„Åø‰∏≠</span></div>
                        <div onclick="updateStatus('invisible')" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20"><div class="status-dot offline relative inline-block border-none"></div><span>„Ç™„Éï„É©„Ç§„É≥</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-section" class="hidden flex-1 md:flex flex-col min-h-0 min-w-0 bg-[var(--bg-primary)]">
            <div class="p-3 border-b flex items-center justify-between flex-shrink-0 bg-[var(--bg-secondary)]" style="border-color: var(--border-color);">
                <div class="font-bold flex items-center truncate">
                    <button id="back-to-channels-btn" class="mr-3 p-1 rounded-full hover:bg-gray-500/20 md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span id="channel-name-text"></span>
                </div>
            </div>
            <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-1"></div>
            <div class="flex-shrink-0 bg-[var(--bg-secondary)]">
                <div id="attachment-preview-bar" class="hidden p-2 text-sm border-t flex items-center justify-between bg-[var(--bg-quaternary)]">
                    <div>Attaching: <b id="attachment-preview-name"></b></div>
                    <button id="cancel-attachment-btn" class="p-1 rounded-full hover:bg-gray-500/30">√ó</button>
                </div>
                <div class="p-4 border-t flex items-end gap-2" style="border-color: var(--border-color);">
                    <input type="file" id="file-input" class="hidden">
                    <button id="attach-button" class="p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">üìé</button>
                    <div class="relative w-full">
                        <div id="reply-bar" class="hidden absolute bottom-full left-0 w-full text-sm p-2 bg-[var(--bg-quaternary)] rounded-t-md">
                            Replying to <b id="reply-username"></b> <button id="cancel-reply-btn" class="ml-2">√ó</button>
                        </div>
                        <textarea id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" class="w-full p-3 rounded-md bg-transparent border dark:border-gray-600 resize-none outline-none" rows="1"></textarea>
                        <div id="char-counter" class="absolute bottom-2 right-2 text-xs opacity-50"></div>
                    </div>
                    <button id="send-button" class="p-3 rounded-md bg-indigo-600 text-white disabled:opacity-50" disabled>üöÄ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="hidden fixed inset-0 bg-black/50 z-50 items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-lg w-full max-w-sm overflow-hidden">
            <div id="profile-modal-header" class="h-20 bg-indigo-600 relative">
                <button onclick="closeProfileModal()" class="absolute top-2 right-2 text-white">√ó</button>
            </div>
            <div class="p-4 pt-0">
                <div class="relative -mt-12 mb-4"><img id="profile-avatar" class="w-24 h-24 rounded-full border-4 border-[var(--bg-secondary)]"></div>
                <h2 id="profile-name" class="text-xl font-bold"></h2>
                <div id="profile-username" class="text-sm opacity-60 mb-4"></div>
                <p id="profile-member-since" class="text-xs opacity-70 mb-4"></p>
                <button id="block-user-btn" class="w-full py-2 rounded-md font-bold text-white"></button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://yakisoba.cloudfree.jp/avoidcord';
        let currentAccount, currentChannel, pollingInterval, timeoutInterval, lastMessageId;
        let lastMessageInfo = { authorId: null, timestamp: null };
        let replyingTo = null;
        let oldestMessageId = null;
        let pingCounts = {};
        let attachedFile = null;

        const getAccounts = () => JSON.parse(localStorage.getItem('accounts')) || [];
        const saveAccounts = (a) => localStorage.setItem('accounts', JSON.stringify(a));
        const getActiveAccountId = () => localStorage.getItem('activeAccountId');
        const setActiveAccountId = (id) => localStorage.setItem('activeAccountId', id);
        const getBlockedUsers = () => JSON.parse(localStorage.getItem('blockedUsers') || '[]');
        const saveBlockedUsers = (b) => localStorage.setItem('blockedUsers', JSON.stringify(b));
        const getStatus = () => localStorage.getItem('userStatus') || 'online';
        const setStatus = (s) => localStorage.setItem('userStatus', s);

        function proxyUrl(url) {
            if (!url) return "";
            return url.replace("cdn.discordapp.com", "yakisoba.cloudfree.jp/avoidcord");
        }

        async function apiRequest(token, path, method = 'GET', body = null, isFormData = false) {
            const headers = { 'Authorization': token };
            if (!isFormData) headers['Content-Type'] = 'application/json';
            const opts = { method, headers };
            if (body) opts.body = isFormData ? body : JSON.stringify(body);
            const r = await fetch(`${API_BASE}${path}`, opts);
            return r.ok ? { data: r.status === 204 ? {} : await r.json(), status: r.status } : { error: await r.json(), status: r.status };
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                if (!currentChannel || !currentAccount) return;
                const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?limit=1`);
                if (res.data && res.data.length > 0) {
                    const m = res.data[0];
                    if (m.id !== lastMessageId) {
                        lastMessageId = m.id;
                        renderMsg(m, true);
                        const con = document.getElementById('message-container');
                        if (con.scrollHeight - con.scrollTop - con.clientHeight < 500) con.scrollTop = con.scrollHeight;
                    }
                }
            }, 3000);
        }

        async function switchAccount(id) {
            if (pollingInterval) clearInterval(pollingInterval);
            setActiveAccountId(id);
            currentAccount = getAccounts().find(a => a.id === id);
            if (!currentAccount) return updateView('auth');
            updateView('app');
            renderUserInfo();
            renderAccountSwitcher();
            loadGuilds();
            startPolling();
        }

        function renderUserInfo() {
            const p = document.getElementById('user-info-panel');
            const status = getStatus();
            p.innerHTML = `<div class="relative w-10 h-10 flex-shrink-0"><img src="${proxyUrl(getAvatarUrl(currentAccount))}" class="w-full h-full rounded-full">${renderStatusDot(status)}</div><div class="flex-1 truncate"><b class="text-sm">${currentAccount.global_name || currentAccount.username}</b><div class="text-xs opacity-60">@${currentAccount.username}</div></div>`;
        }

        function getAvatarUrl(u, size=64) {
            if (u.avatar) return `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=${size}`;
            return `https://cdn.discordapp.com/embed/avatars/${u.discriminator % 5}.png`;
        }

        function renderStatusDot(status) { return `<div class="status-dot ${status || 'offline'}"></div>`; }

        async function loadGuilds() {
            const {data: g} = await apiRequest(currentAccount.token, '/users/@me/guilds');
            if (!g) return;
            const l = document.getElementById('guild-list'); l.innerHTML = '';
            g.forEach(s => {
                const el = document.createElement('div');
                el.className = 'server-icon cursor-pointer';
                el.innerHTML = s.icon ? `<img src="${proxyUrl(`https://cdn.discordapp.com/icons/${s.id}/${s.icon}.png`)}" class="w-full h-full rounded-full">` : `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-white font-bold rounded-full text-xs">${s.name.substring(0, 2)}</div>`;
                el.onclick = () => loadChannels(s, el);
                l.appendChild(el);
            });
        }

        async function loadChannels(g, t) {
            document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
            if (t) t.classList.add('active');
            document.getElementById('guild-name').innerText = g.name;
            const {data: c} = await apiRequest(currentAccount.token, `/guilds/${g.id}/channels`);
            if (!c) return;
            const l = document.getElementById('channel-list'); l.innerHTML = '';
            c.filter(ch => [0, 2, 5].includes(ch.type)).sort((x, y) => x.position - y.position).forEach(ch => {
                const d = document.createElement('div');
                d.className = 'channel-item p-2 rounded cursor-pointer mb-1 text-sm truncate';
                d.innerHTML = `<span>${ch.type === 2 ? 'üîä' : '#'} ${ch.name}</span>`;
                d.onclick = () => selectChannel(ch);
                l.appendChild(d);
            });
        }

        async function selectChannel(ch) {
            currentChannel = ch;
            lastMessageId = null;
            document.getElementById('channel-name-text').innerText = `# ${ch.name}`;
            const con = document.getElementById('message-container');
            con.innerHTML = '<div class="m-auto text-xs opacity-50">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
            const {data: ms} = await apiRequest(currentAccount.token, `/channels/${ch.id}/messages?limit=50`);
            con.innerHTML = '';
            if (ms) {
                ms.reverse().forEach(m => renderMsg(m));
                con.scrollTop = con.scrollHeight;
                if (ms.length > 0) lastMessageId = ms[ms.length - 1].id;
            }
            checkTimeoutStatus(ch.guild_id);
        }

        function renderMsg(m, isNew = false) {
            if (getBlockedUsers().includes(m.author.id)) return;
            const p = document.getElementById('message-container');
            const isGrouped = !isNew && m.author.id === lastMessageInfo.authorId && (new Date(m.timestamp) - new Date(lastMessageInfo.timestamp)) < 300000;
            
            let contentHtml = m.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 hover:underline">$1</a>');

            if (m.attachments) contentHtml += m.attachments.map(a => {
                if (a.content_type?.startsWith('image')) return `<br><img src="${proxyUrl(a.url)}" class="max-w-xs rounded-lg mt-2">`;
                return `<div class="mt-2 p-2 bg-black/10 rounded text-xs"><a href="${proxyUrl(a.url)}" target="_blank">${a.filename}</a></div>`;
            }).join('');

            const el = document.createElement('div');
            el.id = `message-${m.id}`;
            el.className = "message-group relative py-1";
            const toolbar = `<div class="message-toolbar absolute -top-4 right-2 flex bg-[var(--bg-secondary)] border p-1 rounded shadow text-xs"><button onclick='startReply(${JSON.stringify({id:m.id, author:m.author})})' class="px-1">Ëøî‰ø°</button>${m.author.id === currentAccount.id ? `<button onclick='startEdit("${m.id}")' class="px-1">Á∑®ÈõÜ</button><button onclick='deleteMessage("${m.id}")' class="px-1 text-red-500">ÂâäÈô§</button>`:''}</div>`;

            if (isGrouped) {
                el.innerHTML = `<div class="pl-14 text-sm message-content-text">${contentHtml}</div>${toolbar}`;
            } else {
                el.innerHTML = `<div class="flex gap-3"><img src="${proxyUrl(getAvatarUrl(m.author))}" class="w-10 h-10 rounded-full cursor-pointer flex-shrink-0" onclick="openProfileModal('${m.author.id}','${m.guild_id||''}')"><div class="flex-1 min-w-0"><div><b class="text-sm cursor-pointer" onclick="openProfileModal('${m.author.id}')">${m.author.global_name || m.author.username}</b><span class="text-[10px] opacity-40 ml-2">${new Date(m.timestamp).toLocaleString()}</span></div><div class="text-sm message-content-text">${contentHtml}</div></div></div>${toolbar}`;
            }
            el.querySelector('.message-content-text').dataset.originalContent = m.content;
            p.appendChild(el);
            lastMessageInfo = { authorId: m.author.id, timestamp: m.timestamp };
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content && !attachedFile) return;
            const payload = { content };
            if (replyingTo) payload.message_reference = { message_id: replyingTo.messageId };
            
            let res;
            if (attachedFile) {
                const fd = new FormData();
                fd.append('files[0]', attachedFile);
                fd.append('payload_json', JSON.stringify(payload));
                res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', fd, true);
                cancelAttachment();
            } else {
                res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', payload);
            }
            if (!res.error) { input.value = ''; cancelReply(); handleInput(); }
        }

        async function checkTimeoutStatus(guildId) {
            if (!guildId) return;
            const {data: m} = await apiRequest(currentAccount.token, `/guilds/${guildId}/members/${currentAccount.id}`);
            const until = m?.communication_disabled_until;
            if (until && new Date(until) > new Date()) {
                document.getElementById('message-input').disabled = true;
                document.getElementById('message-input').placeholder = "„Çø„Ç§„É†„Ç¢„Ç¶„Éà‰∏≠„Åß„Åô";
            } else {
                document.getElementById('message-input').disabled = false;
                document.getElementById('message-input').placeholder = "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°";
            }
        }

        async function updateStatus(s) {
            setStatus(s);
            renderUserInfo();
            document.getElementById('status-picker').classList.add('hidden');
            // Discord API„Å´Áõ¥Êé•„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„ÇíÊäï„Åí„Çã(WebSocket„Åå„Å™„ÅÑ„Åü„ÇÅÊì¨‰ººÁöÑ„Å™Ë®≠ÂÆö‰øùÂ≠ò„ÅÆ„Åø)
            apiRequest(currentAccount.token, '/users/@me/settings', 'PATCH', { status: s });
        }

        async function openProfileModal(uid, gid) {
            const {data: u} = await apiRequest(currentAccount.token, `/users/${uid}`);
            if (!u) return;
            const modal = document.getElementById('profile-modal');
            document.getElementById('profile-avatar').src = proxyUrl(getAvatarUrl(u, 128));
            document.getElementById('profile-name').innerText = u.global_name || u.username;
            document.getElementById('profile-username').innerText = `@${u.username}`;
            const btn = document.getElementById('block-user-btn');
            const blocked = getBlockedUsers();
            const isBlocked = blocked.includes(uid);
            btn.innerText = isBlocked ? "„Éñ„É≠„ÉÉ„ÇØËß£Èô§" : "„Éñ„É≠„ÉÉ„ÇØ„Åô„Çã";
            btn.className = `w-full py-2 rounded-md font-bold text-white ${isBlocked ? 'bg-gray-600' : 'bg-red-600'}`;
            btn.onclick = () => {
                let list = getBlockedUsers();
                if (isBlocked) list = list.filter(id => id !== uid); else list.push(uid);
                saveBlockedUsers(list); closeProfileModal(); if(currentChannel) selectChannel(currentChannel);
            };
            modal.classList.replace('hidden', 'flex');
        }

        function closeProfileModal() { document.getElementById('profile-modal').classList.replace('flex', 'hidden'); }

        function startReply(m) {
            replyingTo = { messageId: m.id };
            document.getElementById('reply-bar').classList.remove('hidden');
            document.getElementById('reply-username').innerText = m.author.username;
            document.getElementById('message-input').focus();
        }
        function cancelReply() { replyingTo = null; document.getElementById('reply-bar').classList.add('hidden'); }

        function handleInput() {
            const i = document.getElementById('message-input');
            const s = document.getElementById('send-button');
            i.style.height = 'auto'; i.style.height = i.scrollHeight + 'px';
            s.disabled = (i.value.trim() === '' && !attachedFile);
            document.getElementById('char-counter').innerText = i.value.length > 0 ? `${i.value.length}/2000` : '';
        }

        function updateView(v) {
            document.getElementById('auth-section').classList.toggle('hidden', v !== 'auth');
            document.getElementById('main-app').classList.toggle('hidden', v !== 'app');
        }

        function renderAccountSwitcher() {
            const l = document.getElementById('account-list');
            l.innerHTML = getAccounts().map(acc => `<div onclick="switchAccount('${acc.id}')" class="flex items-center gap-2 p-2 hover:bg-black/10 rounded cursor-pointer"><img src="${proxyUrl(getAvatarUrl(acc))}" class="w-6 h-6 rounded-full"><span class="text-xs truncate">${acc.username}</span></div>`).join('');
        }

        document.getElementById('user-info-panel').onclick = () => {
            document.getElementById('status-picker').classList.toggle('hidden');
            document.getElementById('account-switcher').classList.toggle('hidden');
        };

        document.getElementById('add-account-button').onclick = async () => {
            const t = document.getElementById('token-input').value;
            const res = await apiRequest(t, '/users/@me');
            if (res.data) {
                const a = getAccounts(); a.push({...res.data, token: t});
                saveAccounts(a); switchAccount(res.data.id);
            }
        };

        document.getElementById('attach-button').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = (e) => {
            if (e.target.files[0]) {
                attachedFile = e.target.files[0];
                document.getElementById('attachment-preview-name').innerText = attachedFile.name;
                document.getElementById('attachment-preview-bar').classList.remove('hidden');
                handleInput();
            }
        };
        document.getElementById('cancel-attachment-btn').onclick = () => {
            attachedFile = null; document.getElementById('attachment-preview-bar').classList.add('hidden'); handleInput();
        };

        document.getElementById('send-button').onclick = sendMessage;
        document.getElementById('message-input').oninput = handleInput;
        document.getElementById('message-input').onkeypress = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

        document.getElementById('theme-toggle-btn').onclick = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        };

        window.onload = () => {
            if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
            const activeId = getActiveAccountId();
            if (activeId) switchAccount(activeId); else updateView('auth');
        };
    </script>
</body>
</html>
