<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
:root {
    --bg-primary: #f5f5f5;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e3e5e8;
    --bg-quaternary: #ebedef;
    --text-primary: #060607;
    --text-secondary: #5e6772;
    --text-link: #00b0f4;
    --border-color: #d1d5db;
    --button-bg: #5865f2;
    --button-text: #fff;
    --hover-bg: #ebedef;
    --active-bg: #dadce0;
    --mention-bg: rgba(88, 101, 242, 0.1);
    --mention-fg: #5865f2;
    /* Discord„ÅÆ„É°„É≥„Ç∑„Éß„É≥(ÈªÑËâ≤)ËÉåÊôØ */
    --mention-highlight-bg: rgba(250, 166, 26, 0.1); 
    --mention-highlight-bar: #faa61a;
    
    --error-bg: rgba(237, 66, 69, 0.05);
    --error-border: #ed4245;
    --code-bg: #f2f3f5;
    --message-hover: rgba(6, 6, 7, 0.02);
    --popup-bg: #ffffff;
    --popup-highlight: #e3e5e8;
    --reply-spine-color: #c4c9ce; 
    --folder-bg: rgba(88, 101, 242, 0.2);
}

html.dark {
    --bg-primary: #313338;
    --bg-secondary: #2b2d31;
    --bg-tertiary: #1e1f22;
    --bg-quaternary: #111214;
    --text-primary: #f2f3f5;
    --text-secondary: #949ba4;
    --text-link: #00b0f4;
    --border-color: #26272d;
    --button-bg: #5865f2;
    --button-text: #ffffff;
    --hover-bg: #35373c;
    --active-bg: #3f4147;
    --mention-bg: rgba(88, 101, 242, 0.3);
    --mention-fg: #c9cdfb;
    /* Dark mode highlight */
    --mention-highlight-bg: rgba(250, 166, 26, 0.1); 
    --error-bg: rgba(240, 71, 71, 0.1);
    --code-bg: #2b2d31;
    --message-hover: rgba(2, 2, 2, 0.06);
    --popup-bg: #2b2d31;
    --popup-highlight: #35373c;
    --reply-spine-color: #4f545c; 
    --folder-bg: rgba(88, 101, 242, 0.2);
}

/* Scrollbar Customization */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background-color: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background-color: var(--bg-quaternary); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }

/* Utility */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

#message-input::placeholder { color: var(--text-secondary); opacity: 0.7; }
#message-input, .input-field { outline: none; border: none; }

#message-container { overflow-anchor: none; }

/* Drag and Drop Overlay */
#drag-overlay {
    pointer-events: none; opacity: 0; transition: opacity 0.2s;
    background: rgba(88, 101, 242, 0.8);
    border: 4px dashed white;
}
.dragging #drag-overlay { opacity: 1; pointer-events: auto; }

/* Servers & Folders */
.server-icon {
    width: 48px; height: 48px; min-height: 48px;
    border-radius: 50%;
    cursor: pointer; transition: all 0.2s cubic-bezier(0,0,0,1);
    background-color: var(--bg-primary);
    display: flex; align-items: center; justify-content: center;
    position: relative; overflow: visible; z-index: 10;
}
.server-icon img { border-radius: 50%; transition: border-radius 0.2s; }
.server-icon:hover, .server-icon.active { border-radius: 16px; }
.server-icon:hover img, .server-icon.active img { border-radius: 16px; }
.server-icon.active::before {
    content: ''; position: absolute; left: -14px; top: 10px; height: 28px; width: 8px;
    background-color: var(--text-primary); border-radius: 0 4px 4px 0; transition: height 0.2s;
}
.server-icon.in-folder::after {
    content: ''; position: absolute; inset: -4px;
    background-color: rgba(88, 101, 242, 0.1); 
    border-radius: 16px; z-index: -1; 
}
.folder-closed {
    width: 48px; height: 48px; border-radius: 24px;
    background-color: var(--folder-bg); cursor: pointer;
    display: flex; flex-wrap: wrap; padding: 10px; gap: 4px;
    align-items: center; justify-content: center;
    transition: all 0.2s; z-index: 10;
}
.folder-closed:hover { border-radius: 16px; background-color: var(--button-bg); }
.folder-icon-thumb { width: 10px; height: 10px; object-fit: cover; border-radius: 50%; background: var(--bg-secondary); }
.folder-opened {
    background-color: transparent !important; color: var(--text-secondary);
    width: 48px; height: 48px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; padding: 4px;
}

.ping-dot {
    position: absolute; bottom: -2px; right: -2px; width: 16px; height: 16px;
    background-color: #ed4245; border-radius: 50%; border: 4px solid var(--bg-tertiary);
    z-index: 30; pointer-events: none;
}

/* Channels */
.channel-item.active { background-color: var(--active-bg); color: var(--text-primary); }
.channel-item:hover:not(.active) { background-color: var(--hover-bg); color: var(--text-primary); }

/* Avatar Decoration - Resized & Positioned */
.avatar-container {
    width: 40px; height: 40px; margin-top: 2px;
    position: relative; flex-shrink: 0;
    overflow: visible; /* Important to let decoration show */
}
.avatar-img { 
    width: 100%; height: 100%; 
    border-radius: 50%; object-fit: cover;
    position: relative; z-index: 10;
}
.avatar-decoration { 
    position: absolute; 
    top: 50%; left: 50%; 
    width: 140%; height: 140%; /* Icon„Çà„ÇäÂ§ß„Åç„ÅèË°®Á§∫ */
    transform: translate(-50%, -50%); 
    pointer-events: none; z-index: 20; 
    object-fit: contain;
}

/* Messages */
.message-group { 
    position: relative; margin-top: 1.0625rem; width: 100%; 
    display: flex; flex-direction: column; align-items: flex-start; 
}
.message-group.grouped { margin-top: 0.125rem; }
.message-group:hover { background-color: var(--message-hover); }

/* Hover Toolbar */
.message-group:hover .message-toolbar { opacity: 1; transform: translateY(0); pointer-events: auto; }
.message-toolbar { 
    opacity: 0; pointer-events: none; transform: translateY(-4px); transition: all 0.1s; 
    border: 1px solid var(--border-color); 
}

/* Deleted messages: No toolbar, red text */
.message-deleted .message-toolbar { display: none !important; }
.message-deleted .message-content-text { color: #ed4245; }

.message-content-text { width: 100%; user-select: text; overflow-wrap: break-word; word-break: break-word; line-height: 1.375rem; color: var(--text-primary); }

/* Mentions */
.mention {
    background: var(--mention-bg);
    color: var(--mention-fg);
    padding: 0 2px;
    border-radius: 3px;
    font-weight: 500;
    cursor: pointer;
}
.mention:hover { background: var(--button-bg); color: #fff; }

/* Yellow highlight for messages that mention me */
.message-mentioned {
    background-color: var(--mention-highlight-bg) !important;
    position: relative;
}
.message-mentioned::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0;
    width: 2px; background-color: var(--mention-highlight-bar);
}

/* Send Fail States */
.message-sending { opacity: 0.5; } 
.message-failed-text .message-content-text { color: #ed4245 !important; } /* Êú¨‰ΩìÊñáÂ≠ó„ÇíËµ§„Å´ */
.message-deleted-text-label { color: var(--text-secondary); opacity: 0.6; font-size: 0.8rem; margin-left: 5px; user-select: none; }

.history-line { font-size: 0.9em; color: var(--text-secondary); opacity: 0.8; text-decoration: line-through; display: block; margin-bottom: 2px; }
.edited-tag { font-size: 0.625rem; color: var(--text-secondary); margin-left: 4px; user-select: none; }

.flash-highlight { animation: flash-yellow 1.5s ease-out forwards; }
@keyframes flash-yellow { 0%, 20% { background-color: rgba(250, 166, 26, 0.2); } 100% { background-color: transparent; } }

.reply-spine {
    position: absolute; top: 50%; left: -26px; 
    width: 46px; height: 14px;
    border-left: 2px solid var(--reply-spine-color);
    border-top: 2px solid var(--reply-spine-color);
    border-top-left-radius: 6px; margin-top: -6px; pointer-events: none; z-index: 0;
}

/* Custom Context Menu */
#custom-context-menu {
    position: fixed; z-index: 9999;
    background: var(--bg-quaternary);
    border: 1px solid var(--border-color);
    border-radius: 4px; padding: 4px 0;
    min-width: 180px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}
.ctx-item {
    padding: 6px 12px; font-size: 0.9rem; color: var(--text-primary); cursor: pointer;
}
.ctx-item:hover { background: var(--button-bg); color: #fff; }
.ctx-sep { height: 1px; background: var(--border-color); margin: 4px 0; }

.attachment-preview-item {
    position: relative;
}
.attachment-remove-btn {
    position: absolute; top: -5px; right: -5px; 
    background: #ed4245; color: white; border-radius: 50%;
    width: 16px; height: 16px; font-size: 10px; display: flex; 
    align-items: center; justify-content: center; cursor: pointer;
}

/* Toggle Switch */
.switch { position: relative; display: inline-block; width: 40px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #80848e; transition: .4s; border-radius: 24px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
input:checked + .slider { background-color: #3ba55c; }
input:checked + .slider:before { transform: translateX(16px); }

/* Settings */
.settings-tab-item { padding: 6px 12px; border-radius: 4px; cursor: pointer; color: var(--text-secondary); font-weight: 500; }
.settings-tab-item:hover { background-color: var(--hover-bg); color: var(--text-primary); }
.settings-tab-item.active { background-color: var(--active-bg); color: var(--text-primary); cursor: default; }

.plugin-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--bg-quaternary); }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden bg-gray-200 dark:bg-gray-800 text-[var(--text-primary)]">
    
    <div id="drag-overlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center backdrop-blur-sm m-4 rounded-3xl border-dashed">
        <svg class="w-32 h-32 text-white animate-bounce mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
        <div class="text-white text-3xl font-bold">„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
    </div>
    
    <div id="custom-context-menu" class="hidden"></div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex justify-center items-center backdrop-blur-sm">
        <div class="bg-[var(--bg-secondary)] w-full max-w-3xl h-[85vh] rounded-lg shadow-2xl flex overflow-hidden scale-100 transition-transform">
            <div class="w-1/3 bg-[var(--bg-secondary)] p-0 flex flex-col border-r" style="border-color: var(--bg-tertiary);">
                <div class="p-4 font-bold text-xs uppercase text-[var(--text-secondary)] mt-4 mb-2 pl-6">Settings</div>
                <div class="px-2 space-y-1">
                    <div id="tab-btn-plugins" class="settings-tab-item active" onclick="switchSettingsTab('plugins')">Plugins</div>
                    <div id="tab-btn-general" class="settings-tab-item" onclick="switchSettingsTab('general')">General</div>
                </div>
            </div>
            <div class="flex-1 p-8 overflow-y-auto bg-[var(--bg-primary)] relative">
                <div class="absolute top-6 right-8 cursor-pointer text-[var(--text-secondary)] hover:text-[var(--text-primary)]" onclick="document.getElementById('settings-modal').classList.add('hidden')">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </div>
                
                <div id="tab-content-plugins">
                    <h2 class="text-2xl font-bold mb-6">Plugins</h2>
                    <div id="plugin-list" class="space-y-4"></div>
                </div>

                <div id="tab-content-general" class="hidden">
                    <h2 class="text-2xl font-bold mb-6">General</h2>
                    <h3 class="text-sm font-bold uppercase text-[var(--text-secondary)] mb-4">THEME</h3>
                    <div class="flex gap-4">
                        <div class="w-[140px] h-[90px] rounded-lg cursor-pointer flex items-center justify-center bg-[#2f3136] relative border-2 border-transparent hover:border-gray-500" onclick="setTheme('dark')">
                            <span class="text-white font-bold">Dark</span>
                            <div id="theme-check-dark" class="absolute top-2 right-2 w-4 h-4 bg-green-500 rounded-full"></div>
                        </div>
                        <div class="w-[140px] h-[90px] rounded-lg cursor-pointer flex items-center justify-center bg-white border border-gray-300 relative hover:border-gray-400" onclick="setTheme('light')">
                            <span class="text-black font-bold">Light</span>
                            <div id="theme-check-light" class="absolute top-2 right-2 w-4 h-4 bg-green-500 rounded-full hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login UI Omitted for Brevity (Same as provided but logic retained) -->
    <div id="auth-section" class="w-full max-w-md m-auto p-8 rounded-lg shadow-xl flex-col bg-white dark:bg-gray-700 hidden relative z-50">
        <div id="migration-view" class="hidden flex-col items-center justify-center mb-4"><div class="loader mb-2"></div><div class="text-sm font-bold">Loading...</div></div>
        <div id="account-selection-view" class="hidden flex-col">
            <h1 class="text-2xl font-bold text-center mb-6">„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ</h1>
            <div id="saved-accounts-list" class="space-y-2 mb-4 max-h-80 overflow-y-auto"></div>
            <button type="button" id="show-add-account-form-btn" class="mt-2 text-sm text-[var(--text-secondary)] hover:underline text-center w-full">Âà•„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</button>
        </div>
        <div id="token-input-view" class="hidden flex-col">
            <h1 class="text-2xl font-bold text-center mb-2" id="auth-title">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</h1>
            <div id="relogin-user-info" class="hidden flex-col items-center mb-4 p-4 bg-[var(--bg-primary)] rounded-lg">
                <img id="relogin-avatar" src="" class="w-20 h-20 rounded-full mb-2 shadow-md">
                <div id="relogin-name" class="font-bold text-lg"></div>
                <div class="text-xs opacity-60">@<span id="relogin-username"></span></div>
            </div>
            <div id="login-error" class="text-red-500 text-xs mb-3 text-center"></div>
            <form class="space-y-4" onsubmit="return false;">
                <div class="text-xs text-[var(--text-secondary)] uppercase font-bold">„Éà„Éº„ÇØ„É≥</div>
                <input type="password" id="token-input" class="input-field w-full p-2.5 rounded-md bg-[var(--bg-tertiary)] text-[var(--text-primary)]" placeholder="MTE...">
                <button type="button" id="add-account-button" class="bg-blue-600 hover:bg-blue-700 w-full py-3 rounded-md font-bold text-white">„É≠„Ç∞„Ç§„É≥</button>
                <button type="button" id="back-to-accounts-btn" class="text-sm text-[var(--text-secondary)] hover:underline w-full py-2">Êàª„Çã</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden flex-1 flex-row min-h-0 relative">
        <div id="sidebar-view" class="flex flex-row w-full h-full md:w-auto md:flex">
            <div class="p-3 flex flex-col items-center gap-2 overflow-y-auto flex-shrink-0 no-scrollbar" style="background-color: var(--bg-tertiary);">
                <div id="dm-icon" title="DM" class="server-icon bg-indigo-600 flex items-center justify-center cursor-pointer text-white font-black text-xl mb-1 hover:bg-indigo-500 transition-all duration-200 shrink-0 relative z-20">DM</div>
                <div class="w-8 h-[2px] rounded-lg bg-[var(--bg-quaternary)] my-1 shrink-0"></div>
                <div id="guild-list" class="flex flex-col items-center gap-2 w-full pb-4"></div>
            </div>
            
            <div class="w-full md:w-60 flex flex-col border-r flex-1 min-h-0 bg-[var(--bg-secondary)]" style="border-color: var(--bg-tertiary);">
                <div class="h-12 p-3 border-b font-bold truncate flex items-center shadow-sm select-none hover:bg-[var(--hover-bg)] cursor-pointer" id="guild-name" style="border-color: var(--bg-tertiary);"></div>
                <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                
                <div class="relative flex-shrink-0 bg-[var(--bg-tertiary)]/80 backdrop-blur-md">
                    <div id="user-info-panel" class="p-2.5 flex items-center gap-2 h-[58px] cursor-pointer" onclick="document.getElementById('account-switcher').classList.toggle('hidden')">
                        <div class="relative w-9 h-9 flex-shrink-0">
                            <div id="current-user-avatar-container" class="w-full h-full relative"></div>
                        </div>
                        <div class="flex-1 min-w-0 flex flex-col justify-center select-none">
                             <div class="text-sm font-bold truncate leading-tight" id="current-user-name"></div>
                             <div class="text-xs opacity-60 truncate leading-tight" id="current-user-subtext"></div>
                        </div>
                        <button id="open-settings-btn" class="p-2 hover:bg-[var(--active-bg)] rounded-md cursor-pointer text-[var(--text-secondary)] hover:text-[var(--text-primary)]" onclick="event.stopPropagation(); renderSettingsModal();">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></svg>
                        </button>
                    </div>

                    <div id="account-switcher" class="hidden absolute bottom-[110%] left-2 min-w-[240px] rounded-lg shadow-xl overflow-hidden border z-50 bg-[var(--popup-bg)]" style="border-color: var(--border-color);">
                        <div id="account-list" class="max-h-60 overflow-y-auto p-1 space-y-0.5"></div>
                        <div class="border-t p-1 mt-1" style="border-color: var(--border-color);">
                            <div id="add-account-switcher-btn" class="text-sm p-2 rounded cursor-pointer hover:bg-indigo-500 hover:text-white flex items-center gap-2 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                „Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-section" class="hidden flex-1 md:flex flex-col min-h-0 min-w-0 bg-[var(--bg-primary)] relative">
            <div class="h-12 p-3 border-b flex items-center justify-between flex-shrink-0 shadow-sm" style="border-color: var(--bg-tertiary); background-color:var(--bg-secondary);">
                <div class="font-bold flex items-center truncate">
                    <button id="back-to-channels-btn" class="mr-3 p-1 rounded-full hover:bg-[var(--bg-tertiary)] md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span id="channel-name-text"></span>
                </div>
            </div>
            
            <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-0" style="background-color: var(--bg-primary);"></div>
            
            <div class="flex-shrink-0 pt-0">
                <div id="attachment-list" class="hidden px-4 py-2 text-sm border-t flex flex-wrap gap-2 bg-[var(--bg-secondary)]" style="border-color: var(--bg-tertiary);"></div>
                
                <div class="px-4 pb-4 pt-1 bg-[var(--bg-primary)]">
                    <div class="flex items-start gap-2 bg-[var(--bg-tertiary)] p-2 rounded-lg relative transition-all shadow-sm" style="min-height: 44px;">
                        <input type="file" id="file-input" class="hidden" multiple>
                        
                        <button id="attach-button" class="p-2 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-colors mt-0.5">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                        </button>

                        <div class="relative w-full self-center">
                            <div id="reply-bar" class="hidden flex items-center justify-between text-sm text-[var(--text-secondary)] mb-1 px-1 opacity-80">
                                 <span class="truncate">Replying to <b id="reply-username"></b></span>
                                 <button id="cancel-reply-btn" class="p-0.5 rounded-full hover:text-[var(--text-primary)]">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                            
                            <textarea id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" class="input-field w-full bg-transparent p-1.5 text-[0.95rem] resize-none max-h-[50vh] focus:outline-none min-h-[24px]" rows="1"></textarea>
                            <div id="char-counter" class="absolute bottom-1 right-1 text-[10px] font-mono font-bold text-[var(--text-secondary)] opacity-0 pointer-events-none select-none"></div>
                        </div>
                        
                        <button id="send-button" class="p-2 rounded-lg text-[var(--button-bg)] hover:bg-[var(--hover-bg)] disabled:opacity-40 disabled:cursor-not-allowed transition-colors self-end" disabled>
                            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
const API_BASE = 'https://discord.com/api/v10';
let ws = null;
let currentAccount = null;
let currentChannel = null;
let lastSequence = null;
let heartbeatInterval = null;
let replyingTo = null;
let oldestMessageId = null;
let isLoadingMore = false;
let attachedFiles = [];
let maxCharCount = 2000;
let guildFolders = [];
let guildDataMap = new Map();
let openFolderId = null; 
let pingCounts = {};
let messageStore = {}; 
let editedMessages = {}; 
let dragCounter = 0;

const plugins = JSON.parse(localStorage.getItem('plugins')) || {
    showMeYourName: false,
    sendSeconds: false,
    messageLogger: true,
    clickAction: true,
    showCharacter: true
};

document.addEventListener('DOMContentLoaded', async () => {
    if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    }
    
    document.addEventListener('contextmenu', handleContextMenu);
    document.addEventListener('click', () => document.getElementById('custom-context-menu').classList.add('hidden'));

    // Paste Support
    document.body.addEventListener('paste', e => {
        const files = e.clipboardData.files;
        if (files.length > 0) {
            e.preventDefault();
            handleFiles(files);
        }
    });
    
    // Drag & Drop
    const overlay = document.getElementById('drag-overlay');
    document.addEventListener('dragenter', (e) => { e.preventDefault(); dragCounter++; document.body.classList.add('dragging'); });
    document.addEventListener('dragleave', (e) => { e.preventDefault(); dragCounter--; if(dragCounter===0) document.body.classList.remove('dragging'); });
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', (e) => {
        e.preventDefault(); dragCounter = 0; document.body.classList.remove('dragging');
        handleFiles(e.dataTransfer.files);
    });

    document.getElementById('dm-icon').onclick = loadDms;
    document.getElementById('send-button').onclick = sendMessage;
    
    document.getElementById('attach-button').onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').onchange = (e) => handleFiles(e.target.files);

    document.getElementById('cancel-reply-btn').onclick = cancelReply;
    
    const input = document.getElementById('message-input');
    input.oninput = handleInput;
    input.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        if (e.key === 'ArrowUp' && input.value === '') {
            e.preventDefault();
            editLastOwnMessage();
        }
    };

    document.getElementById('back-to-channels-btn').onclick = showSidebarView;
    document.getElementById('open-settings-btn').onclick = (e) => { e.stopPropagation(); renderSettingsModal(); };
    document.getElementById('add-account-switcher-btn').onclick = () => { document.getElementById('account-switcher').classList.add('hidden'); showLoginScreen(); };
    document.getElementById('show-add-account-form-btn').onclick = () => showTokenInput();
    document.getElementById('back-to-accounts-btn').onclick = () => { document.getElementById('token-input-view').classList.add('hidden'); document.getElementById('account-selection-view').classList.remove('hidden'); document.getElementById('account-selection-view').classList.add('flex'); };

    window.addEventListener('resize', handleResize);

    const accounts = getAccounts();
    const activeId = getActiveAccountId();
    if (accounts.length > 0 && activeId) switchAccount(activeId);
    else showLoginScreen();
});

const getAccounts = () => JSON.parse(localStorage.getItem('accounts')) || [];
const saveAccounts = a => localStorage.setItem('accounts', JSON.stringify(a));
const getActiveAccountId = () => localStorage.getItem('activeAccountId');
const setActiveAccountId = id => localStorage.setItem('activeAccountId', id);

function handleFiles(files) {
    if(attachedFiles.length >= 10) return alert('Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„ÅØÊúÄÂ§ß10ÂÄã„Åæ„Åß„Åß„Åô');
    for (let f of files) {
        if(attachedFiles.length < 10) attachedFiles.push(f);
    }
    renderAttachments();
    handleInput();
}

function renderAttachments() {
    const list = document.getElementById('attachment-list');
    list.innerHTML = '';
    if(attachedFiles.length === 0) { list.classList.add('hidden'); return; }
    list.classList.remove('hidden');
    
    attachedFiles.forEach((f, idx) => {
        const d = document.createElement('div');
        d.className = "bg-[var(--bg-tertiary)] px-2 py-1 rounded text-xs flex items-center attachment-preview-item border border-[var(--border-color)]";
        d.innerHTML = `<span class="truncate max-w-[150px]">${f.name}</span><div class="attachment-remove-btn">√ó</div>`;
        d.querySelector('.attachment-remove-btn').onclick = () => {
            attachedFiles.splice(idx, 1);
            renderAttachments();
            handleInput();
        };
        list.appendChild(d);
    });
}

function clearAttachments() {
    attachedFiles = [];
    document.getElementById('file-input').value = "";
    renderAttachments();
    handleInput();
}

async function apiRequest(token, path, method = 'GET', body = null, isFormData = false) {
    const opts = { method, headers: { 'Authorization': token, 'X-Super-Properties': btoa(JSON.stringify({ os: "Windows", browser: "Chrome", device: "", system_locale: "ja", client_build_number: 262355 })) } };
    if (body) {
        if (isFormData) opts.body = body;
        else { opts.body = JSON.stringify(body); opts.headers['Content-Type'] = 'application/json'; }
    }
    try {
        const r = await fetch(`${API_BASE}${path}`, opts);
        if (r.status === 401) return { error: { message: "Unauthorized" }, status: 401 };
        const data = r.status === 204 ? {} : await r.json();
        if (!r.ok) return { error: data, status: r.status };
        return { data, status: r.status };
    } catch (e) { return { error: { message: "Network error" }, status: 0 }; }
}

function cleanupState() {
    if (ws) { ws.onclose = null; ws.close(); ws = null; }
    currentChannel = null; attachedFiles = [];
    if (heartbeatInterval) clearInterval(heartbeatInterval);
    document.getElementById('guild-list').innerHTML = '';
    document.getElementById('channel-list').innerHTML = '';
    document.getElementById('message-container').innerHTML = '';
    document.getElementById('guild-name').innerText = '';
    messageStore = {}; guildDataMap.clear(); editedMessages = {}; pingCounts = {};
    cancelReply(); clearAttachments();
}

function switchAccount(id) {
    cleanupState();
    setActiveAccountId(id);
    const acc = getAccounts().find(a => a.id === id);
    if (!acc) { showLoginScreen(); return; }
    currentAccount = acc;
    maxCharCount = (currentAccount.premium_type === 2) ? 4000 : 2000;
    updateView('app'); renderCurrentUserPanel(); loadGuilds();
    setTimeout(connectWS, 100);
}

function updateView(view) {
    const auth = document.getElementById('auth-section');
    const app = document.getElementById('main-app');
    if (view === 'auth') { auth.classList.remove('hidden'); auth.classList.add('flex'); app.classList.add('hidden'); } 
    else { auth.classList.add('hidden'); app.classList.remove('hidden'); app.classList.add('flex'); if(window.innerWidth<768) showSidebarView(); }
}

function showLoginScreen() {
    cleanupState(); updateView('auth');
    document.getElementById('token-input-view').classList.add('hidden');
    renderSavedAccountsList();
    const accs = getAccounts();
    if(accs.length>0) {
        document.getElementById('account-selection-view').classList.remove('hidden');
        document.getElementById('account-selection-view').classList.add('flex');
    } else showTokenInput();
}

function showTokenInput() {
    document.getElementById('account-selection-view').classList.add('hidden');
    document.getElementById('account-selection-view').classList.remove('flex');
    document.getElementById('token-input-view').classList.remove('hidden');
    document.getElementById('token-input-view').classList.add('flex');
    document.getElementById('add-account-button').onclick = () => addAccount(document.getElementById('token-input').value);
}

function handleResize() { if (window.innerWidth >= 768) { document.getElementById('sidebar-view').classList.remove('hidden'); } }
function showSidebarView() { document.getElementById('sidebar-view').classList.remove('hidden'); document.getElementById('chat-section').classList.add('hidden'); }
function showChatView() { document.getElementById('sidebar-view').classList.add('hidden'); document.getElementById('chat-section').classList.remove('hidden'); document.getElementById('chat-section').classList.add('flex'); }

function renderSavedAccountsList() {
    const list = document.getElementById('saved-accounts-list');
    list.innerHTML = '';
    getAccounts().forEach(acc => {
        const d = document.createElement('div');
        d.className = "flex items-center gap-3 p-3 border rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer";
        d.style.borderColor = 'var(--border-color)';
        const av = acc.avatar ? `https://cdn.discordapp.com/avatars/${acc.id}/${acc.avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/${acc.discriminator % 5}.png`;
        d.innerHTML = `<img src="${av}" class="w-10 h-10 rounded-full bg-gray-300"><div class="flex-1 min-w-0"><div class="font-bold truncate">${acc.global_name || acc.username}</div></div><div class="delete-btn p-2 text-red-400">√ó</div>`;
        d.onclick = (e) => { if(!e.target.classList.contains('delete-btn')) switchAccount(acc.id); };
        d.querySelector('.delete-btn').onclick = (e) => deleteAccount(acc.id, e);
        list.appendChild(d);
    });
}

function renderCurrentUserPanel() {
    if (!currentAccount) return;
    document.getElementById('current-user-name').innerText = currentAccount.global_name || currentAccount.username;
    document.getElementById('current-user-subtext').innerText = `@${currentAccount.username}`;
    const av = currentAccount.avatar ? `https://cdn.discordapp.com/avatars/${currentAccount.id}/${currentAccount.avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/${currentAccount.discriminator % 5}.png`;
    let deco = '';
    if(currentAccount.avatar_decoration_data) deco = `<img src="https://cdn.discordapp.com/avatar-decoration-presets/${currentAccount.avatar_decoration_data.asset}.png?size=96" class="avatar-decoration">`;
    document.getElementById('current-user-avatar-container').innerHTML = `<img src="${av}" class="avatar-img shadow-sm rounded-full">${deco}`;
    renderAccountSwitcher();
}

function renderAccountSwitcher() {
    const list = document.getElementById('account-list');
    list.innerHTML = getAccounts().map(acc => {
        const av = acc.avatar ? `https://cdn.discordapp.com/avatars/${acc.id}/${acc.avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/${acc.discriminator % 5}.png`;
        return `<div class="flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-[var(--button-bg)] hover:text-white group" onclick="switchAccount('${acc.id}')">
            <img src="${av}" class="w-8 h-8 rounded-full"><span class="flex-1 truncate text-sm font-semibold">${acc.global_name || acc.username}</span>
            <div onclick="deleteAccount('${acc.id}',event)" title="ÂâäÈô§" class="hidden group-hover:block px-2 text-sm hover:text-red-300">√ó</div>
        </div>`;
    }).join('');
}

function createServerIconElement(s, isInFolder=false) {
    let el = document.createElement('div'); el.id = `guild-${s.id}`; 
    el.className = 'server-icon group ' + (isInFolder?'in-folder':''); el.dataset.guildId = s.id;
    el.title = s.name;
    el.innerHTML = s.icon ? `<img src="https://cdn.discordapp.com/icons/${s.id}/${s.icon}.png?size=128" class="object-cover w-full h-full">` : `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-white font-bold text-sm rounded-full transition-all group-hover:rounded-2xl">${s.name.substring(0,2)}</div>`;
    el.onclick = () => loadChannels(s, el);
    return el;
}

function renderFolders() {
    const list = document.getElementById('guild-list'); list.innerHTML = '';
    guildFolders.forEach(item => {
        if (item.guild_ids && item.id) {
            const folderWrap = document.createElement('div');
            folderWrap.className = 'flex flex-col items-center gap-2 w-full transition-all';
            const childs = item.guild_ids.map(id => guildDataMap.get(id)).filter(Boolean);
            if(childs.length===0) return;
            
            const header = document.createElement('div'); header.className = 'folder-closed group';
            let fColor = item.color ? `rgba(${(item.color>>16)&255},${(item.color>>8)&255},${item.color&255},0.4)` : 'rgba(88,101,242,0.4)';
            header.style.backgroundColor = fColor;
            
            const makeMini = () => { header.innerHTML=''; childs.slice(0,4).forEach(g=>{header.innerHTML+=`<img class="folder-icon-thumb" src="${g.icon?`https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png?size=64`:`https://cdn.discordapp.com/embed/avatars/0.png`}">`}) };
            makeMini();

            const body = document.createElement('div'); body.className = 'hidden flex-col gap-2 items-center w-full py-1';
            childs.forEach(g => body.appendChild(createServerIconElement(g, true)));
            
            header.onclick = () => {
                if(openFolderId === item.id) { openFolderId = null; body.classList.replace('flex','hidden'); header.classList.replace('folder-opened','folder-closed'); header.style.backgroundColor=fColor; makeMini(); }
                else {
                    if(openFolderId) document.querySelector(`#guild-list .folder-opened`)?.click();
                    openFolderId=item.id; body.classList.replace('hidden','flex'); header.classList.replace('folder-closed','folder-opened');
                    header.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>`.replace('M19 13','M20 7H12L10 5H4C2.9 5 2.01 5.9 2.01 7L2 19C2 20.1 2.9 21 4 21H20C21.1 21 22 20.1 22 19V9C22 7.9 21.1 7 20 7Z');
                }
            };
            folderWrap.appendChild(header); folderWrap.appendChild(body); list.appendChild(folderWrap);
        } else item.guild_ids?.forEach(gid => { const s=guildDataMap.get(gid); if(s) list.appendChild(createServerIconElement(s)); });
    });
}

async function loadGuilds() {
    if (!currentAccount) return;
    const res = await apiRequest(currentAccount.token, '/users/@me/guilds');
    if (res.error) { if (res.status === 401) showLoginScreen(); return; }
    guildDataMap.clear(); res.data.forEach(s => guildDataMap.set(s.id, s));
    if (guildFolders.length > 0) renderFolders();
    else { const list=document.getElementById('guild-list'); list.innerHTML=''; res.data.forEach(s=>list.appendChild(createServerIconElement(s))); }
}

async function loadDms() {
    document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
    document.getElementById('dm-icon').classList.add('active');
    document.getElementById('guild-name').innerText = 'Direct Messages';
    const res = await apiRequest(currentAccount.token, '/users/@me/channels');
    const list = document.getElementById('channel-list'); list.innerHTML = '';
    if(res.data) res.data.sort((a,b)=>(b.last_message_id||0)-(a.last_message_id||0)).forEach(dm => {
        const d = document.createElement('div');
        d.className = "channel-item p-1.5 pl-3 rounded-md cursor-pointer mb-0.5 text-[0.95em] truncate flex items-center";
        d.onclick = () => selectChannel(dm);
        d.id = `channel-${dm.id}`;
        let name = "DM", av = "";
        if(dm.recipients?.[0]) { name = dm.recipients[0].global_name || dm.recipients[0].username; av=`<img src="https://cdn.discordapp.com/avatars/${dm.recipients[0].id}/${dm.recipients[0].avatar}.png?size=32" class="w-5 h-5 mr-2 rounded-full">`; }
        d.innerHTML = `${av||'<span class="text-xl mr-2 text-gray-500">@</span>'}<span>${name}</span>`;
        list.appendChild(d);
    });
    updatePingDots();
}

async function loadChannels(g, el) {
    document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
    if(el) el.classList.add('active');
    document.getElementById('guild-name').innerText = g.name;
    const res = await apiRequest(currentAccount.token, `/guilds/${g.id}/channels`);
    const list = document.getElementById('channel-list'); list.innerHTML = '';
    if(!res.data) return;
    const groups = res.data.reduce((a,c)=>{ (a[c.parent_id||'null']=a[c.parent_id||'null']||[]).push(c); return a; }, {});
    
    const render = (c, cat) => {
        if(![0,5,2].includes(c.type)) return;
        const d=document.createElement('div'); d.id=`channel-${c.id}`; d.dataset.channelId = c.id;
        d.className=`channel-item p-1.5 pl-3 rounded-md cursor-pointer mb-0.5 flex items-center ${cat?'ml-2':''} ${c.type===2?'opacity-50':''}`;
        d.innerHTML = (c.type===2?'<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 24 24"><path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>':'<span class="text-lg mr-2 text-gray-500">#</span>') + `<span class="truncate font-medium">${c.name}</span>`;
        if(c.type!==2) d.onclick = () => selectChannel(c);
        list.appendChild(d);
    }
    
    (groups['null']||[]).sort((a,b)=>a.position-b.position).forEach(c=>render(c));
    res.data.filter(c=>c.type===4).sort((a,b)=>a.position-b.position).forEach(c => {
        const cat = document.createElement('div'); cat.className='px-2 pt-4 pb-1 text-xs font-bold uppercase text-[var(--text-secondary)] select-none cursor-pointer flex items-center';
        cat.innerHTML = `<svg class="w-3 h-3 mr-1 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> ${c.name}`;
        cat.onclick = () => { cat.nextElementSibling.classList.toggle('hidden'); cat.querySelector('svg').style.transform = cat.nextElementSibling.classList.contains('hidden')?'rotate(-90deg)':''; };
        list.appendChild(cat);
        const wrapper = document.createElement('div');
        (groups[c.id]||[]).sort((a,b)=>a.position-b.position).forEach(ch=>wrapper.appendChild((()=>{const el=document.createElement('div'); render(ch,true); return list.lastChild;})()));
        list.appendChild(wrapper);
    });
    updatePingDots();
}

async function selectChannel(ch) {
    currentChannel = ch; oldestMessageId = null; cancelReply(); clearAttachments();
    document.querySelectorAll('.channel-item.active').forEach(e => e.classList.remove('active'));
    const ce = document.getElementById(`channel-${ch.id}`); if(ce) ce.classList.add('active');
    delete pingCounts[ch.id]; updatePingDots();
    
    if(window.innerWidth < 768) showChatView();
    let n = ch.name || (ch.recipients?ch.recipients[0].username:"DM");
    document.getElementById('channel-name-text').innerHTML = `<span class="opacity-50 mr-1">#</span>${n}`;
    const c = document.getElementById('message-container'); c.innerHTML='<div class="flex items-center justify-center h-full"><div class="loader"></div></div>';
    
    const res = await apiRequest(currentAccount.token, `/channels/${ch.id}/messages?limit=50`);
    c.innerHTML='';
    if(res.error) { c.innerHTML='<div class="text-red-500 text-center p-8 font-bold">„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì</div>'; return; }
    
    if(res.data.length>0) {
        oldestMessageId = res.data[res.data.length-1].id;
        const frag = document.createDocumentFragment();
        res.data.slice().reverse().forEach((m,i,arr) => {
            const prev = i>0?arr[i-1]:null;
            const grouped = prev && prev.author.id===m.author.id && !m.referenced_message && !prev.webhook_id && (new Date(m.timestamp)-new Date(prev.timestamp)<300000);
            frag.appendChild(createMessageElement(m, grouped));
        });
        c.appendChild(frag);
        c.scrollTop = c.scrollHeight;
    }
}

document.getElementById('message-container').addEventListener('scroll', async function() {
    if(this.scrollTop < 50 && oldestMessageId && !isLoadingMore && currentChannel) {
        isLoadingMore = true; const sh = this.scrollHeight;
        const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?limit=50&before=${oldestMessageId}`);
        if(res.data?.length>0) {
            oldestMessageId = res.data[res.data.length-1].id;
            const f = document.createDocumentFragment();
            let lastT = 0, lastA = null;
            res.data.reverse().forEach((m, i) => {
               const g = i>0 && m.author.id===lastA && !m.referenced_message && (new Date(m.timestamp).getTime()-lastT<300000);
               f.appendChild(createMessageElement(m, g)); lastT=new Date(m.timestamp).getTime(); lastA=m.author.id;
            });
            this.prepend(f);
            this.scrollTop = this.scrollHeight - sh;
        } else oldestMessageId=null;
        isLoadingMore = false;
    }
});

function formatTime(d) {
    const pad = n => n.toString().padStart(2,'0');
    return `${d.getFullYear()} ${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function parseMarkdown(t) {
    if (!t) return '';
    let h = t.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // Channel Links <#ID>
    h = h.replace(/&lt;#(\d+)&gt;/g, (m,id) => `<span class="text-[var(--text-link)] cursor-pointer hover:underline font-medium" onclick="handleChannelLink('${id}')">#channel</span>`);
    // Custom Emojis <:name:id> or <a:name:id>
    h = h.replace(/&lt;(a?):(\w+):(\d+)&gt;/g, (m,a,n,id) => `<img src="https://cdn.discordapp.com/emojis/${id}.${a?'gif':'png'}" class="w-6 h-6 inline-block align-middle hover:scale-125 transition-transform" title=":${n}:">`);
    // Mentions <@ID>
    h = h.replace(/&lt;@!?(\d+)&gt;/g, (m,id) => `<span class="mention" onclick="handleUserLink('${id}')">@${id}</span>`);
    // Links
    h = h.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-[var(--text-link)] hover:underline">$1</a>');
    return h.replace(/\n/g, '<br>');
}

function handleChannelLink(id) {
    const el = document.getElementById(`channel-${id}`);
    if(el) el.click();
    else alert('„ÉÅ„É£„É≥„Éç„É´ID: '+id+' („Åì„ÅÆ„Çµ„Éº„Éê„ÉºÂ§ñ„ÅãË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì)');
}

function createMessageElement(m, grouped) {
    if(plugins.messageLogger) messageStore[m.id] = m;
    let text = parseMarkdown(m.content);
    const mentionsMe = m.mentions?.some(u => u.id === currentAccount.id) || m.content.includes(`<@${currentAccount.id}>`);
    
    // Resolve Mentions Names
    if (m.mentions) m.mentions.forEach(u => text = text.replace(`@${u.id}`, `@${u.global_name||u.username}`));
    // Deleted Handling
    let deletedHtml = '';
    if(m.deleted) {
        deletedHtml = `<span class="message-deleted-text-label">(deleted)</span>`;
        // Text is handled by class
    }

    const isMe = m.author.id === currentAccount.id;
    let accessories = '';
    if (m.attachments) m.attachments.forEach(a => {
        if(a.content_type?.startsWith('image/')) accessories += `<a href="${a.url}" target="_blank"><img src="${a.url}" class="max-w-xs max-h-80 rounded-lg mt-2 block bg-gray-900"></a>`;
        else accessories += `<div class="mt-2 p-3 bg-[var(--bg-tertiary)] border rounded w-fit text-sm"><a href="${a.url}" target="_blank" class="text-[var(--text-link)] font-mono">üìé ${a.filename}</a></div>`;
    });
    
    const timeStr = formatTime(new Date(m.timestamp));
    const containerClass = `message-group w-full relative pl-16 pr-4 ${grouped?'grouped mt-[2px]':'mt-[1.1rem]'} ${mentionsMe?'message-mentioned':''} ${m.deleted?'message-deleted':''} ${m.isFailed?'message-failed-text':''}`;
    const el = document.createElement('div'); 
    el.className = containerClass; el.id = `message-${m.id}`; el.dataset.messageId=m.id; el.dataset.authorId=m.author.id;
    
    if(plugins.clickAction && !m.deleted) el.addEventListener('dblclick', () => startReply(m));

    let toolbar = '';
    if(!m.deleted) {
        toolbar = `<div class="message-toolbar absolute -top-4 right-4 rounded shadow-sm bg-[var(--bg-secondary)] flex items-center p-0.5 z-20 border border-[var(--border-color)]">
            ${isMe ? `<button class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded text-gray-500" onclick="startEdit('${m.id}')">‚úèÔ∏è</button><button class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded text-red-500" onclick="deleteMessage('${m.id}')">üóëÔ∏è</button>` : ''}
            <button class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded text-gray-500" onclick='startReply(${JSON.stringify({id:m.id,author:m.author})})'>‚Ü©Ô∏è</button>
        </div>`;
    }

    let refHtml = '';
    if(m.referenced_message && !grouped) {
        const rm = m.referenced_message;
        refHtml = `<div class="absolute top-1 left-[70px] -mt-5 opacity-70 text-sm flex items-center gap-1 w-fit cursor-pointer select-none" onclick="scrollToMsg('${rm.id}')"><div class="reply-spine"></div><img src="${rm.author?.avatar?`https://cdn.discordapp.com/avatars/${rm.author.id}/${rm.author.avatar}.png?size=16`:'https://cdn.discordapp.com/embed/avatars/0.png'}" class="w-4 h-4 rounded-full"><span class="font-bold text-xs">@${rm.author?.global_name||rm.author?.username||'User'}</span> <span class="text-xs truncate max-w-[200px]">${rm.content||'Click to view'}</span></div>`;
    }

    if(grouped) {
        el.innerHTML = `${toolbar} <div class="message-content-text relative pl-1">${text}${deletedHtml}</div> ${accessories}`;
    } else {
        const u = m.author;
        const avUrl = u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/${u.discriminator%5}.png`;
        let deco = u.avatar_decoration_data ? `<img src="https://cdn.discordapp.com/avatar-decoration-presets/${u.avatar_decoration_data.asset}.png?size=96" class="avatar-decoration">` : '';
        
        el.innerHTML = `
        ${refHtml} ${toolbar}
        <div class="absolute left-4 top-0 w-10 h-10 cursor-pointer avatar-container select-none">
            <img src="${avUrl}" class="avatar-img rounded-full shadow-sm">
            ${deco}
        </div>
        <div class="flex items-baseline gap-2 leading-snug">
            <span class="font-medium hover:underline cursor-pointer" style="${m.member?.color?`color:#${m.member.color.toString(16).padStart(6,'0')}`:''}">${m.member?.nick||u.global_name||u.username}</span>
            <span class="text-xs text-[var(--text-secondary)] font-medium">${timeStr}</span>
        </div>
        <div class="message-content-text mt-0.5 relative">${text}${deletedHtml}</div>
        ${accessories}`;
    }
    
    // System message handling (Join)
    if(m.type === 7) {
        el.className = 'px-4 py-2 opacity-70 flex items-center gap-2 text-green-500';
        el.innerHTML = `<span>üëã</span> <b>${m.author.global_name||m.author.username}</b> „Åå„Çµ„Éº„Éê„Éº„Å´ÂèÇÂä†„Åó„Åæ„Åó„ÅüÔºÅ`;
    }

    // Append Clyde if Failed
    if (m.isFailed) {
        const clydeId = 'clyde-'+m.id;
        const clydeDiv = document.createElement('div');
        clydeDiv.className = 'mt-1 ml-0 flex gap-2 select-none opacity-90';
        clydeDiv.innerHTML = `<div class="w-[3px] bg-red-500 rounded ml-1"></div>
            <div class="ml-2 text-sm">
                <div class="flex items-center gap-1 mb-1">
                    <span class="bg-[#5865F2] text-white text-[10px] px-1 rounded">Clyde</span>
                    <span class="text-xs opacity-80">System</span>
                </div>
                <div class="opacity-90">„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü (${m.errorReason || 'Unknown'})</div>
                <div class="text-xs mt-1">
                    <span class="opacity-70">„Åì„Çå„Çâ„ÅØ„ÅÇ„Å™„Åü„Å´„Å†„ÅëË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</span> ‚Ä¢ 
                    <span class="text-[var(--text-link)] cursor-pointer hover:underline" onclick="document.getElementById('message-${m.id}').remove()">„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§</span>
                </div>
            </div>`;
        el.appendChild(clydeDiv);
    }

    return el;
}

async function sendMessage() {
    if(!currentChannel || !currentAccount) return;
    const box = document.getElementById('message-input');
    let txt = box.value.trim();
    if(!txt && attachedFiles.length===0) return;

    // Check Max Length
    if (txt.length > maxCharCount) {
        if(confirm(`ÊñáÂ≠óÊï∞„ÅåÂ§ö„Åô„Åé„Åæ„Åô(${txt.length} / ${maxCharCount})„ÄÇ\n"message.txt" „Å®„Åó„Å¶„Éï„Ç°„Ç§„É´ÈÄÅ‰ø°„Åó„Åæ„Åô„ÅãÔºü`)) {
            const blob = new Blob([txt], {type: 'text/plain'});
            const file = new File([blob], "message.txt", {type: 'text/plain'});
            if(attachedFiles.length < 10) attachedFiles.push(file);
            txt = ""; 
        } else return;
    }
    
    // UI update immediate (clearing inputs) to prevent double click
    const sendTxt = txt;
    const sendFiles = [...attachedFiles];
    box.value = ''; attachedFiles = []; renderAttachments(); handleInput();

    // Temp Message
    const now = new Date();
    const tempId = 'temp-'+now.getTime();
    const fake = { id:tempId, author:currentAccount, content:sendTxt, timestamp:now.toISOString(), isSending:true, attachments: sendFiles.map(f=>({url:'#',filename:f.name})) };
    renderMsg(fake, true);

    const body = new FormData();
    body.append('payload_json', JSON.stringify({ content: sendTxt, message_reference: replyingTo ? { message_id: replyingTo.messageId } : undefined }));
    sendFiles.forEach((f,i) => body.append(`files[${i}]`, f));
    
    const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', body, true);
    
    const tempEl = document.getElementById(`message-${tempId}`);
    if (res.error) {
        // Replace temp styling with error state
        fake.isSending = false; fake.isFailed = true; fake.errorReason = res.error.message || 'Error';
        const newEl = createMessageElement(fake, tempEl?.classList.contains('grouped'));
        if(tempEl) tempEl.replaceWith(newEl);
        scrollBottom();
    } else {
        if(tempEl) tempEl.remove(); // The websocket event will insert the real message, avoid duplicates
        cancelReply();
    }
}

function handleInput() {
    const i=document.getElementById('message-input'), b=document.getElementById('send-button'), c=document.getElementById('char-counter');
    i.style.height='auto'; i.style.height=i.scrollHeight+'px';
    const l=i.value.length;
    b.disabled = l===0 && attachedFiles.length===0;
    c.classList.toggle('opacity-0', !plugins.showCharacter);
    c.innerText = `${l} / ${maxCharCount}`; c.style.color=l>maxCharCount?'#ed4245':'';
}

function renderMsg(m, forceScroll=false) {
    const c = document.getElementById('message-container');
    const bottom = c.scrollTop + c.clientHeight >= c.scrollHeight - 50;
    
    const prev = c.lastElementChild;
    let grouped = false;
    if(prev && !m.isSending && !prev.classList.contains('message-sending') && !m.type) {
         if(prev.dataset.authorId === m.author.id && !m.webhook_id && !m.referenced_message) grouped=true;
    }
    c.appendChild(createMessageElement(m, grouped));
    
    if (bottom || forceScroll || m.author.id === currentAccount.id) c.scrollTop = c.scrollHeight;
}

function connectWS() {
    if (!currentAccount) return; if(ws) ws.close();
    ws = new WebSocket('wss://gateway.discord.gg/?v=10&encoding=json');
    ws.onmessage = e => {
        const d = JSON.parse(e.data);
        if (d.s) lastSequence = d.s;
        if(d.op===10) { heartbeatInterval = setInterval(()=>ws.send(JSON.stringify({op:1,d:lastSequence})), d.d.heartbeat_interval); ws.send(JSON.stringify({op:2,d:{token:currentAccount.token,properties:{$os:"linux",$browser:"disco",$device:"disco"}}})); }
        else if (d.t === 'READY') { if(d.d.user_settings?.guild_folders) { guildFolders=d.d.user_settings.guild_folders; renderFolders(); } }
        else if (d.t === 'MESSAGE_CREATE' && d.d.channel_id===currentChannel?.id) { document.querySelectorAll('.message-sending').forEach(e=>e.remove()); renderMsg(d.d); }
        else if (d.t === 'MESSAGE_CREATE') { 
            const men = d.d.mentions?.find(u=>u.id===currentAccount.id);
            if(men || (d.d.referenced_message?.author.id===currentAccount.id)) { pingCounts[d.d.channel_id]=(pingCounts[d.d.channel_id]||0)+1; updatePingDots(); }
        }
        else if (d.t === 'MESSAGE_DELETE' && messageStore[d.d.id]) { 
            const m = messageStore[d.d.id]; m.deleted=true; rerenderMsg(d.d.id, m);
        }
        else if (d.t === 'MESSAGE_UPDATE' && d.d.id && messageStore[d.d.id]) {
            const m = {...messageStore[d.d.id], ...d.d}; messageStore[d.d.id]=m; rerenderMsg(d.d.id, m);
        }
    }
    ws.onclose = () => setTimeout(connectWS, 3000);
}

function rerenderMsg(id, m) {
    const el = document.getElementById(`message-${id}`); if(!el) return;
    const n = createMessageElement(m, el.classList.contains('grouped'));
    el.replaceWith(n);
}

// Right Click Context Menu
function handleContextMenu(e) {
    const mEl = e.target.closest('.message-group');
    const cEl = e.target.closest('.channel-item');
    const sEl = e.target.closest('.server-icon');
    
    if (mEl || cEl || sEl) {
        e.preventDefault();
        const menu = document.getElementById('custom-context-menu');
        menu.innerHTML = '';
        
        const addItem = (txt, fn, color='') => {
            const d = document.createElement('div'); d.className = `ctx-item ${color}`;
            d.innerText = txt; d.onclick = fn; menu.appendChild(d);
        };

        if (mEl) {
            const id = mEl.dataset.messageId;
            const content = mEl.querySelector('.message-content-text')?.innerText || '';
            const mData = messageStore[id];
            
            addItem('Copy Text', () => { navigator.clipboard.writeText(content); });
            addItem('Copy ID', () => { navigator.clipboard.writeText(id); });
            if (mData && mData.author.id === currentAccount.id && !mData.deleted) {
                menu.appendChild(document.createElement('div')).className='ctx-sep';
                addItem('Edit', () => startEdit(id));
                addItem('Delete', () => deleteMessage(id), 'text-red-500');
            }
        }
        else if (cEl) {
            const id = cEl.dataset.channelId;
            addItem('Copy Channel ID', () => navigator.clipboard.writeText(id));
        }
        else if (sEl) {
            const id = sEl.dataset.guildId;
            addItem('Copy Server ID', () => navigator.clipboard.writeText(id));
        }
        
        menu.classList.remove('hidden');
        let x = e.pageX, y = e.pageY;
        if(x + 200 > window.innerWidth) x -= 200;
        menu.style.left = x + 'px'; menu.style.top = y + 'px';
    } else {
        document.getElementById('custom-context-menu').classList.add('hidden');
    }
}

async function deleteMessage(id) {
    await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${id}`, 'DELETE');
    const el=document.getElementById(`message-${id}`);
    if(el) { el.querySelector('.message-content-text').style.color='#ed4245'; el.classList.add('message-deleted'); }
}

function startEdit(id) {
    const el = document.getElementById(`message-${id}`).querySelector('.message-content-text');
    const old = messageStore[id]?.content || el.innerText;
    el.innerHTML = `<textarea class="input-field w-full p-2 bg-[var(--bg-tertiary)] rounded outline-none h-auto border border-blue-500" rows="1">${old}</textarea><div class="text-xs mt-1"><span class="text-blue-500 cursor-pointer hover:underline" onclick="saveEdit('${id}', this.previousElementSibling.value)">‰øùÂ≠ò</span> ‚Ä¢ <span class="cursor-pointer hover:underline" onclick="rerenderMsg('${id}', messageStore['${id}'])">„Ç≠„É£„É≥„Çª„É´</span></div>`;
    el.querySelector('textarea').focus();
    el.querySelector('textarea').onkeydown = e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); saveEdit(id, e.target.value); } if(e.key==='Escape') rerenderMsg(id, messageStore[id]); }
}
async function saveEdit(id, txt) { await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${id}`, 'PATCH', {content: txt}); }

function editLastOwnMessage() {
    const list = Array.from(document.querySelectorAll('.message-group'));
    for (let i = list.length - 1; i >= 0; i--) {
        const el = list[i];
        if (el.dataset.authorId === currentAccount.id && !el.classList.contains('message-deleted') && !el.classList.contains('message-failed-text')) {
            startEdit(el.dataset.messageId); break;
        }
    }
}

function addAccount(token) {
    token = token.trim().replace(/^"|"$/g,'');
    if(!token) return;
    document.getElementById('login-error').innerText='';
    const btn = document.getElementById('add-account-button'); btn.innerText='Á¢∫Ë™ç‰∏≠...'; btn.disabled=true;
    fetch('https://discord.com/api/v10/users/@me', {headers:{'Authorization':token}}).then(r=>r.json()).then(d=>{
        btn.disabled=false; btn.innerText='„É≠„Ç∞„Ç§„É≥';
        if(d.id) { const a=getAccounts(); if(!a.find(x=>x.id===d.id)) a.push({...d, token}); else a[a.findIndex(x=>x.id===d.id)]={...d, token}; saveAccounts(a); switchAccount(d.id); }
        else document.getElementById('login-error').innerText = "ÁÑ°Âäπ„Å™„Éà„Éº„ÇØ„É≥„Åß„Åô";
    });
}
function deleteAccount(id,e) { e.stopPropagation(); const a=getAccounts().filter(x=>x.id!==id); saveAccounts(a); if(getActiveAccountId()===id) showLoginScreen(); else renderAccountSwitcher(); }

function scrollToMsg(id) {
    const el = document.getElementById(`message-${id}`);
    if (el) { el.scrollIntoView({behavior:'auto',block:'center'}); el.classList.add('flash-highlight'); setTimeout(()=>el.classList.remove('flash-highlight'),1500); }
    else alert('„É°„ÉÉ„Çª„Éº„Ç∏„Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
}

function startReply(m) { replyingTo = {messageId: m.id, author: m.author}; document.getElementById('reply-bar').classList.remove('hidden'); document.getElementById('reply-bar').classList.add('flex'); document.getElementById('reply-username').innerText = m.author.global_name||m.author.username; document.getElementById('message-input').focus(); }
function cancelReply() { replyingTo = null; document.getElementById('reply-bar').classList.add('hidden'); document.getElementById('reply-bar').classList.remove('flex'); }

function renderPluginList() {
    const l = document.getElementById('plugin-list'); l.innerHTML = '';
    const items = [
        {k:'clickAction',n:'Double Click Reply',d:'„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßËøî‰ø°'},
        {k:'showCharacter',n:'Character Counter',d:'ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„Çø„ÉºË°®Á§∫'},
        {k:'messageLogger',n:'Message Logger',d:'ÂâäÈô§Ê∏à„Åø„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫(„É≠„Ç∞‰øùÊåÅ)'},
    ];
    items.forEach(p => {
        l.innerHTML += `<div class="plugin-item"><div><div class="font-bold">${p.n}</div><div class="text-xs opacity-70">${p.d}</div></div><label class="switch"><input type="checkbox" ${plugins[p.k]?'checked':''} onchange="plugins['${p.k}']=this.checked;localStorage.setItem('plugins',JSON.stringify(plugins));handleInput()"><span class="slider"></span></label></div>`;
    });
    l.innerHTML += `<a href="https://github.com/Bloxd-H/discord_lite" target="_blank" class="block mt-4 text-xs text-blue-500 hover:underline">GitHub Repository: Bloxd-H/discord_lite</a>`;
}
function renderSettingsModal() { switchSettingsTab('plugins'); renderPluginList(); document.getElementById('theme-check-'+(localStorage.theme||'dark')).classList.remove('hidden'); document.getElementById('settings-modal').classList.remove('hidden'); }
function switchSettingsTab(t) { document.querySelectorAll('.settings-tab-item').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-btn-${t}`).classList.add('active'); document.querySelectorAll('[id^=tab-content]').forEach(e=>e.classList.add('hidden')); document.getElementById(`tab-content-${t}`).classList.remove('hidden'); }
function setTheme(t) { localStorage.theme=t; document.documentElement.className=t==='dark'?'dark':''; document.getElementById('theme-check-dark').classList.toggle('hidden',t!=='dark'); document.getElementById('theme-check-light').classList.toggle('hidden',t!=='light'); }
function updatePingDots() { document.querySelectorAll('.ping-dot').forEach(e=>e.remove()); Object.keys(pingCounts).forEach(id=>{if(pingCounts[id]>0) document.getElementById(`channel-${id}`)?.insertAdjacentHTML('beforeend','<div class="ping-dot"></div>')}); }
    </script>
</body>
</html>
